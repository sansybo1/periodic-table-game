<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ØªÙƒØ§ÙØ¤Ø§Øª</title>
<style>
:root{
  --bg-dark:#0f1720; --bg-light:#f5f5f5;
  --card-dark:#1e293b; --card-light:#fff;
  --text-dark:#e2e8f0; --text-light:#1e293b;
  --accent:#06b6d4; --ok:#10b981; --bad:#ef4444;
}

/* Background with abstract chemical hex pattern */
body {
  margin:0; padding:0; width:100%; height:100%; 
  font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial; 
  transition: background 0.3s, color 0.3s;
  background-color: var(--bg-dark);
  color: var(--text-dark);
  /* Abstract Hex Pattern */
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(6, 182, 212, 0.15), transparent 25%), 
    radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.15), transparent 25%),
    url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.07'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

body.light {
  background-color: var(--bg-light);
  color: var(--text-light);
  background-image: 
    radial-gradient(circle at 15% 50%, rgba(6, 182, 212, 0.1), transparent 25%), 
    url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

/* LTR support */
html[lang="en"] { direction: ltr; }

.wrap{
  width:100%; 
  min-height:100vh; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  justify-content:flex-start; 
  padding: 4vh 5vw;
  box-sizing:border-box; 
  overflow-y:auto;
}

/* Main Title - BIGGER */
h1 {
  text-align:center; 
  margin:2vh 0 5vh; 
  font-size: 7vh; 
  font-weight: 900;
  text-shadow: 0 4px 15px rgba(0,0,0,0.3);
  line-height: 1.2;
}

button{cursor:pointer; border:0; border-radius:16px; padding:20px 30px; font-size:2.8vh; font-weight:bold; transition: transform 0.1s, box-shadow 0.2s; margin: 8px;}
button:active{transform:scale(0.97);}
.primary{background:linear-gradient(135deg, var(--accent), #0891b2); color:#fff; box-shadow:0 4px 15px rgba(6,182,212,0.4);}
.danger{background:var(--bad); color:#fff;}

.hidden{display:none !important;}

.card{
  background:var(--card-dark); 
  border-radius:24px; 
  margin-top:2vh; 
  border:1px solid rgba(255,255,255,0.1); 
  width:100%; 
  padding: 40px; 
  box-sizing:border-box; 
  font-size:3vh;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

.controls{
  display:flex; flex-wrap:wrap; justify-content:space-between; 
  gap: 15px; margin: 2vh 0; font-size:2.2vh; width: 100%; padding: 0 10px;
}
.row{display:flex; align-items:center; gap: 10px; background:rgba(0,0,0,0.2); padding:8px 15px; border-radius:12px;}

/* INPUT FIELD - BIGGER & CENTERED */
input[type="text"]{
  padding:25px; 
  font-size: 5vh; 
  font-weight: bold;
  letter-spacing: 2px;
  border-radius:16px; 
  border:3px solid var(--accent); 
  width:100%; 
  box-sizing:border-box; 
  text-align:center;
  background: rgba(255,255,255,0.05);
  color: inherit;
  margin-bottom: 25px;
  box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
}
input[type="text"]:focus{ outline:none; background: rgba(255,255,255,0.1); border-color: var(--ok); }

select{padding:8px 15px; font-size:2.2vh; border-radius:8px; border:0; cursor:pointer; background:var(--bg-light); color:#333; font-weight:bold;}

#langSelect { padding: 10px 20px; font-size: 2vh; border: 2px solid var(--accent); }

.progress{height:20px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; width: 100%;}
.bar{height:100%; background:linear-gradient(90deg,#06b6d4,#10b981); width:0%; transition: width 1s linear;}
.rank{padding:5px 15px; border-radius:20px; font-size:2.2vh; background:var(--accent); color:#fff; display:inline-block;}

#menu{text-align:center; width:100%; max-width: 700px;}
#menu button{width:100%; margin:2vh 0; padding: 30px; font-size: 3.5vh;}

#game { width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center; }

body.light .card{background:#fff; border:2px solid #e2e8f0; box-shadow: 0 10px 30px rgba(0,0,0,0.05);}
body.light button{border: 1px solid #ddd;} 
body.light .primary{border:none; color: #fff;}
body.light .row{background:rgba(0,0,0,0.05);}
body.light input[type="text"]{background: #f8fafc; border: 3px solid #cbd5e1; color: #333;}

#loseScreen{position:fixed; top:0; left:0; width:100vw; height:100vh; background:linear-gradient(135deg,#7f1d1d,#3b0b0b); display:flex; align-items:center; justify-content:center; flex-direction:column; font-size:4vh; color:#fff; z-index:999; text-align:center; opacity:0; pointer-events:none; transition:opacity .25s;}
#loseScreen.show{opacity:1; pointer-events:auto;}

#celebration{position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.98); display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:5vh; color:#10b981; z-index:1000; text-align:center; opacity:0; pointer-events:none; transition:opacity 0.3s; padding: 20px;}
#celebration.show{opacity:1; pointer-events:auto;}

.settings-row { display: flex; justify-content: center; gap: 30px; margin-top: 4vh; align-items: center;}
.header-row { display:flex; justify-content:space-between; align-items:center; font-size:2.5vh; margin-bottom: 20px; opacity: 0.8;}

/* Dynamic XP text */
.xp-popup { position: absolute; color: var(--ok); font-weight: bold; font-size: 3vh; animation: floatUp 1s ease-out forwards; pointer-events: none; }
@keyframes floatUp { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-50px); } }
</style>
</head>
<body>
<div class="wrap">
  <div id="menu">
    <h1 id="titleText">âš›ï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ØªÙƒØ§ÙØ¤Ø§Øª</h1>
    <button id="menuQuiz" class="primary">ğŸ§ª ØªØ­Ø¯ÙŠ Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ù†Ø§ØµØ±</button>
    <button id="menuVal" class="primary">âš–ï¸ ØªØ­Ø¯ÙŠ ØªÙƒØ§ÙØ¤Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±</button>
    
    <div style="margin-top:4vh">
      <button id="clearSave" class="danger" style="font-size:2.2vh; padding: 15px;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­ÙØ¸ (Reset)</button>
    </div>
    
    <div class="settings-row">
       <label style="cursor:pointer; display:flex; align-items:center; gap:10px; font-size:2.2vh;">
         <input id="toggleMode" type="checkbox"> 
         <span id="lblMode">Ù†Ù‡Ø§Ø±/Ù„ÙŠÙ„</span>
       </label>
       
       <select id="langSelect">
         <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
         <option value="en">English</option>
       </select>
    </div>
  </div>

  <div id="game" class="hidden">
    <div style="width:100%; display:flex; justify-content:flex-start;">
      <button id="backMenu" class="danger" style="padding: 10px 20px; font-size: 2vh;">â¬… <span id="txtBack">Ø§Ù„Ø¹ÙˆØ¯Ø©</span></button>
    </div>

    <div class="controls">
      <div class="row"><span id="lblDiff">Ø§Ù„ØµØ¹ÙˆØ¨Ø©</span>:
        <select id="difficulty">
          <option value="easy" selected id="optEasy">Ø³Ù‡Ù„</option>
          <option value="hard" id="optHard">ØµØ¹Ø¨</option>
        </select>
      </div>
      <div class="row"><span id="lblTime">Ø§Ù„ÙˆÙ‚Øª</span>:
        <select id="timeLimit">
          <option value="8">8s (XP++)</option>
          <option value="12" selected>12s</option>
          <option value="20">20s (XP--)</option>
        </select>
      </div>
      <div class="row"><span id="lblXP">Ø®Ø¨Ø±Ø©</span>: <span id="xp" style="color:var(--accent); font-weight:bold;">0</span></div>
      <div class="row"><span id="lblRank">Ø±ØªØ¨Ø©</span>: <span id="rank" class="rank">...</span></div>
    </div>

    <div id="quiz" class="card hidden">
      <div class="header-row">
        <div id="quizHeader">ğŸ§ª Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø²</div>
        <div><span id="quizTimerLbl">Ø§Ù„ÙˆÙ‚Øª</span>: <span id="timer" style="font-family:monospace; font-weight:bold; color:var(--bad);">--</span></div>
      </div>
      
      <div id="quizInfo" style="text-align:center; font-size:6vh; margin: 3vh 0;">
        <div id="qName" style="font-weight:900; color:var(--accent); text-shadow: 0 0 30px rgba(6,182,212,0.3);">â€”</div>
      </div>
      
      <div style="width:100%; position:relative;">
        <input id="answer" placeholder="Symbol (e.g. H)" autocomplete="off" />
        <button id="submit" class="primary" style="width:100%">âœ” <span id="btnCheck1">ØªØ­Ù‚Ù‚</span></button>
      </div>

      <div style="margin-top:3vh; display:flex; justify-content:space-between; align-items:center; gap:20px;">
        <div style="white-space:nowrap;"><span id="streakLbl1">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</span>: <span id="streak" style="font-weight:bold; color:var(--ok)">0</span></div>
        <div style="flex-grow:1;"><div class="progress"><div id="timebar" class="bar"></div></div></div>
      </div>
    </div>

    <div id="valency" class="card hidden">
      <div class="header-row">
        <div id="valHeader">âš–ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´Ø­Ù†Ø©</div>
        <div><span id="valTimerLbl">Ø§Ù„ÙˆÙ‚Øª</span>: <span id="valTimer" style="font-family:monospace; font-weight:bold; color:var(--bad);">--</span></div>
      </div>

      <div id="valInfo" style="text-align:center; font-size:6vh; margin: 3vh 0;">
        <div id="valPrompt" style="font-weight:900; color:var(--accent); text-shadow: 0 0 30px rgba(6,182,212,0.3);">â€”</div>
        <div class="small-muted" style="margin-top:1vh; font-size:2.2vh; opacity:0.6; font-weight:normal;" id="valNote">(Ø¨Ø¯ÙˆÙ† Ø¥Ø´Ø§Ø±Ø© = Ù…ÙˆØ¬Ø¨)</div>
      </div>

      <div style="width:100%; position:relative;">
        <input id="valAnswer" placeholder="+1, -2, 0" autocomplete="off" />
        <button id="valSubmit" class="primary" style="width:100%">âœ” <span id="btnCheck2">ØªØ­Ù‚Ù‚</span></button>
      </div>

      <div style="margin-top:3vh; display:flex; justify-content:space-between; align-items:center; gap:20px;">
        <div style="white-space:nowrap;"><span id="streakLbl2">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</span>: <span id="valStreak" style="font-weight:bold; color:var(--ok)">0</span></div>
        <div style="flex-grow:1;"><div class="progress"><div id="valTimebar" class="bar"></div></div></div>
      </div>
    </div>

  </div>
</div>

<div id="loseScreen">
  <div id="loseText">
    <div style="margin-bottom:20px">âŒ <span id="txtWrong">Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!</span></div>
    <div style="font-size:3vh"><span id="txtCorrectIs">Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ</span>: <strong id="loseAnswer" style="color:#4ade80; font-size:8vh; display:block; margin-top:20px"></strong></div>
  </div>
</div>

<div id="celebration"><span id="celText">ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!</span></div>

<script>
// --- Data ---
// Expanded dataset with all requested elements for "Easy" and "Hard" logic
const elements=[
// Originals
{symbol:'H',name:'Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ†',en:'Hydrogen',val:['+1']},
{symbol:'He',name:'Ø§Ù„Ù‡ÙŠÙ„ÙŠÙˆÙ…',en:'Helium',val:['0']},
{symbol:'Li',name:'Ø§Ù„Ù„ÙŠØ«ÙŠÙˆÙ…',en:'Lithium',val:['+1']},
{symbol:'Be',name:'Ø§Ù„Ø¨ÙŠØ±ÙŠÙ„ÙŠÙˆÙ…',en:'Beryllium',val:['+2']},
{symbol:'B',name:'Ø§Ù„Ø¨ÙˆØ±ÙˆÙ†',en:'Boron',val:['+3']},
{symbol:'C',name:'Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†',en:'Carbon',val:['+4','-4']},
{symbol:'N',name:'Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†',en:'Nitrogen',val:['+5','-3']},
{symbol:'O',name:'Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†',en:'Oxygen',val:['-2']},
{symbol:'F',name:'Ø§Ù„ÙÙ„ÙˆØ±',en:'Fluorine',val:['-1']},
{symbol:'Ne',name:'Ø§Ù„Ù†ÙŠÙˆÙ†',en:'Neon',val:['0']},
{symbol:'Na',name:'Ø§Ù„ØµÙˆØ¯ÙŠÙˆÙ…',en:'Sodium',val:['+1']},
{symbol:'Mg',name:'Ø§Ù„Ù…ØºÙ†ÙŠØ³ÙŠÙˆÙ…',en:'Magnesium',val:['+2']},
{symbol:'Al',name:'Ø§Ù„Ø£Ù„Ù…Ù†ÙŠÙˆÙ…',en:'Aluminium',val:['+3']},
{symbol:'Si',name:'Ø§Ù„Ø³ÙŠÙ„ÙŠÙƒÙˆÙ†',en:'Silicon',val:['+4','-4']},
{symbol:'P',name:'Ø§Ù„ÙØ³ÙÙˆØ±',en:'Phosphorus',val:['+5','-3']},
{symbol:'S',name:'Ø§Ù„ÙƒØ¨Ø±ÙŠØª',en:'Sulfur',val:['-2','+6']},
{symbol:'Cl',name:'Ø§Ù„ÙƒÙ„ÙˆØ±',en:'Chlorine',val:['-1','+1','+5','+7']},
{symbol:'Ar',name:'Ø§Ù„Ø£Ø±Ø¬ÙˆÙ†',en:'Argon',val:['0']},
{symbol:'K',name:'Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…',en:'Potassium',val:['+1']},
{symbol:'Ca',name:'Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ…',en:'Calcium',val:['+2']},
// New Additions for "Easy" Set
{symbol:'Rb',name:'Ø§Ù„Ø±ÙˆØ¨ÙŠØ¯ÙŠÙˆÙ…',en:'Rubidium',val:['+1']},
{symbol:'Cs',name:'Ø§Ù„Ø³ÙŠØ²ÙŠÙˆÙ…',en:'Cesium',val:['+1']},
{symbol:'Sr',name:'Ø§Ù„Ø³ØªØ±ÙˆÙ†Ø´ÙŠÙˆÙ…',en:'Strontium',val:['+2']},
{symbol:'Ba',name:'Ø§Ù„Ø¨Ø§Ø±ÙŠÙˆÙ…',en:'Barium',val:['+2']},
{symbol:'Cr',name:'Ø§Ù„ÙƒØ±ÙˆÙ…',en:'Chromium',val:['+2','+3','+6']},
{symbol:'Mn',name:'Ø§Ù„Ù…Ù†ØºÙ†ÙŠØ²',en:'Manganese',val:['+2','+4','+7']},
{symbol:'Fe',name:'Ø§Ù„Ø­Ø¯ÙŠØ¯',en:'Iron',val:['+2','+3']},
{symbol:'Co',name:'Ø§Ù„ÙƒÙˆØ¨Ø§Ù„Øª',en:'Cobalt',val:['+2','+3']},
{symbol:'Cu',name:'Ø§Ù„Ù†Ø­Ø§Ø³',en:'Copper',val:['+1','+2']},
{symbol:'Ag',name:'Ø§Ù„ÙØ¸Ø©',en:'Silver',val:['+1']},
{symbol:'Au',name:'Ø§Ù„Ø°Ù‡Ø¨',en:'Gold',val:['+1','+3']},
{symbol:'Zn',name:'Ø§Ù„Ø²Ù†Ùƒ',en:'Zinc',val:['+2']},
{symbol:'Hg',name:'Ø§Ù„Ø²Ø¦Ø¨Ù‚',en:'Mercury',val:['+1','+2']},
{symbol:'Sn',name:'Ø§Ù„Ù‚ØµØ¯ÙŠØ±',en:'Tin',val:['+2','+4']},
{symbol:'Pb',name:'Ø§Ù„Ø±ØµØ§Øµ',en:'Lead',val:['+2','+4']},
{symbol:'Br',name:'Ø§Ù„Ø¨Ø±ÙˆÙ…',en:'Bromine',val:['-1']},
{symbol:'I',name:'Ø§Ù„ÙŠÙˆØ¯',en:'Iodine',val:['-1']},
{symbol:'Kr',name:'Ø§Ù„ÙƒØ±ÙŠØ¨ØªÙˆÙ†',en:'Krypton',val:['0']},
{symbol:'Xe',name:'Ø§Ù„Ø²ÙŠÙ†ÙˆÙ†',en:'Xenon',val:['0']},
{symbol:'Rn',name:'Ø§Ù„Ø±Ø§Ø¯ÙˆÙ†',en:'Radon',val:['0']}
];

// The Specific List defined for Easy Mode
const easySymbols = ['H','Li','Be','Na','K','Rb','Cs','Mg','Ca','Sr','Ba','Cr','Mn','Fe','Co','Cu','Ag','Au','Zn','Hg','B','Al','C','Si','Sn','Pb','N','P','O','S','F','Cl','Br','I','He','Ne','Ar','Kr','Xe','Rn'];

// --- Translation Dictionary ---
const dictionary = {
  ar: {
    title: "âš›ï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ØªÙƒØ§ÙØ¤Ø§Øª",
    btnQuiz: "ğŸ§ª ØªØ­Ø¯ÙŠ Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ù†Ø§ØµØ±",
    btnVal: "âš–ï¸ ØªØ­Ø¯ÙŠ ØªÙƒØ§ÙØ¤Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±",
    reset: "ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­ÙØ¸",
    mode: "Ù†Ù‡Ø§Ø±/Ù„ÙŠÙ„",
    back: "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©",
    diff: "Ø§Ù„ØµØ¹ÙˆØ¨Ø©",
    time: "Ø§Ù„ÙˆÙ‚Øª",
    xp: "Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø©",
    rank: "Ø§Ù„Ø±ØªØ¨Ø©",
    easy: "Ø³Ù‡Ù„", hard: "ØµØ¹Ø¨", // Medium removed
    qHeader: "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØŸ",
    phSym: "Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§",
    check: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
    streak: "ğŸ”¥ ØªØªØ§Ø¨Ø¹",
    vHeader: "Ù…Ø§ Ù‡Ùˆ ØªÙƒØ§ÙØ¤ Ø§Ù„Ø¹Ù†ØµØ±ØŸ",
    vNote: "(Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¯ÙˆÙ† Ø¥Ø´Ø§Ø±Ø© ÙŠØ­Ø³Ø¨ Ù…ÙˆØ¬Ø¨)",
    wrong: "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!",
    correctIs: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ",
    cel: "ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø±ØªØ¨Ø©:"
  },
  en: {
    title: "âš›ï¸ Elements & Valencies",
    btnQuiz: "ğŸ§ª Symbol Challenge",
    btnVal: "âš–ï¸ Valency Challenge",
    reset: "ğŸ—‘ï¸ Reset Save",
    mode: "Day/Night",
    back: "Main Menu",
    diff: "Diff",
    time: "Time",
    xp: "XP",
    rank: "Rank",
    easy: "Easy", hard: "Hard",
    qHeader: "What is the Symbol?",
    phSym: "Type symbol here",
    check: "Submit Answer",
    streak: "ğŸ”¥ Streak",
    vHeader: "What is the Valency?",
    vNote: "(Note: No sign = Positive)",
    wrong: "Wrong Answer!",
    correctIs: "The correct answer is:",
    cel: "ğŸ‰ Congrats! New Rank:"
  }
};

const tiers=[
  {xp:0,name:'Ù…Ø¨ØªØ¯Ø¦ ÙƒÙŠÙ…ÙŠØ§Ø¡', en:'Novice Learner'},
  {xp:100,name:'Ø·Ø§Ù„Ø¨ Ù…Ø¬ØªÙ‡Ø¯', en:'Advanced Student'},
  {xp:300,name:'Ø®Ø¨ÙŠØ± Ø§Ù„Ù…Ø¹Ù…Ù„', en:'Lab Expert'},
  {xp:600,name:'Ù…Ø§ÙŠØ³ØªØ±Ùˆ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', en:'Chemistry Maestro'},
  {xp:1200,name:'Ø¹Ø§Ù„Ù… Ø°Ø±Ø©', en:'Atomic Scientist'},
  {xp:2500,name:'Ù…Ù†Ø¯Ù„ÙŠÙŠÙ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ', en:'Legendary Mendeleev'}
];

// --- Globals & DOM ---
let currentLang = 'ar';
const LS_KEY='chem_game_v6_ultra';
let activeTimer = null; 

const menu=document.getElementById('menu'), game=document.getElementById('game');
const menuQuiz=document.getElementById('menuQuiz'), menuVal=document.getElementById('menuVal');
const backMenu=document.getElementById('backMenu'), clearSaveBtn=document.getElementById('clearSave');
const toggleMode=document.getElementById('toggleMode'), langSelect=document.getElementById('langSelect');
const quizDiv=document.getElementById('quiz'), qName=document.getElementById('qName'), timerEl=document.getElementById('timer'), answerInput=document.getElementById('answer'), submitBtn=document.getElementById('submit'), streakEl=document.getElementById('streak'), xpEl=document.getElementById('xp'), rankEl=document.getElementById('rank'), timebar=document.getElementById('timebar');
const valDiv=document.getElementById('valency'), valPrompt=document.getElementById('valPrompt'), valTimerEl=document.getElementById('valTimer'), valAnswer=document.getElementById('valAnswer'), valSubmit=document.getElementById('valSubmit'), valStreakEl=document.getElementById('valStreak'), valTimebar=document.getElementById('valTimebar');
const loseScreen=document.getElementById('loseScreen'), loseAnswerEl=document.getElementById('loseAnswer');
const celebration=document.getElementById('celebration');

let xp=0, streak=0, current=null, quizList=[], quizIndex=0, valList=[], valIndex=0, timeLeft=0, currentMode=null;
const correctSound=new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
const wrongSound=new Audio('https://assets.mixkit.co/sfx/preview/mixkit-wrong-buzz-907.mp3');

// --- Helper Functions ---
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}
function clearAllTimers(){if(activeTimer){clearInterval(activeTimer); activeTimer=null;}}
function normalizeValInput(s){if(!s) return null;s=s.toString().trim().replace(/\s+/g,'');if(/^[+-]?\d+$/.test(s)){if(s==='0'||s==='+0'||s==='-0')return'0'; if(/^[+-]/.test(s))return (s[0]==='+')?('+'+parseInt(s,10)):'-'+Math.abs(parseInt(s,10)); return '+'+parseInt(s,10);} return null;}
function valAcceptedFor(elem,answerNormalized){if(!elem||!elem.val)return false; return elem.val.some(v=>{if(v==='0')return answerNormalized==='0'; return v===answerNormalized;});}

// Calculate XP based on Time and Difficulty
function calculateXP(){
  let base = 10;
  const timeSetting = parseInt(document.getElementById('timeLimit').value);
  const diffSetting = document.getElementById('difficulty').value;
  
  let multiplier = 1;
  
  // Time Multipliers
  if(timeSetting === 8) multiplier *= 1.5; // Less time = More XP
  if(timeSetting === 20) multiplier *= 0.5; // More time = Less XP
  
  // Difficulty Multipliers
  if(diffSetting === 'hard') multiplier *= 1.5; // Hard = More XP
  
  return Math.ceil(base * multiplier);
}

// Show floating XP animation
function showFloatingXP(amount, x, y){
  const el = document.createElement('div');
  el.className = 'xp-popup';
  el.textContent = `+${amount} XP`;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1000);
}

// Filter elements based on difficulty
function getGameElements(){
  const diff = document.getElementById('difficulty').value;
  if(diff === 'easy'){
    // Return only elements in the easySymbols list
    return elements.filter(e => easySymbols.includes(e.symbol));
  } else {
    // Hard mode = All elements
    return elements.slice();
  }
}

// --- Localization Logic ---
function applyLanguage(){
  const t = dictionary[currentLang];
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
  
  document.getElementById('titleText').textContent = t.title;
  menuQuiz.textContent = t.btnQuiz;
  menuVal.textContent = t.btnVal;
  clearSaveBtn.textContent = t.reset;
  document.getElementById('lblMode').textContent = t.mode;
  
  document.getElementById('txtBack').textContent = t.back;
  document.getElementById('lblDiff').textContent = t.diff;
  document.getElementById('lblTime').textContent = t.time;
  document.getElementById('lblXP').textContent = t.xp;
  document.getElementById('lblRank').textContent = t.rank;
  document.getElementById('optEasy').textContent = t.easy;
  document.getElementById('optHard').textContent = t.hard;
  
  document.getElementById('quizHeader').textContent = t.qHeader;
  answerInput.placeholder = t.phSym;
  document.getElementById('btnCheck1').textContent = t.check;
  document.getElementById('streakLbl1').textContent = t.streak;
  document.getElementById('quizTimerLbl').textContent = t.time;

  document.getElementById('valHeader').textContent = t.vHeader;
  document.getElementById('valNote').textContent = t.vNote;
  document.getElementById('btnCheck2').textContent = t.check;
  document.getElementById('streakLbl2').textContent = t.streak;
  document.getElementById('valTimerLbl').textContent = t.time;

  document.getElementById('txtWrong').textContent = t.wrong;
  document.getElementById('txtCorrectIs').textContent = t.correctIs;

  updateStats(false);
  
  if(current){
    if(currentMode==='quiz') qName.textContent = currentLang==='ar' ? current.name : current.en;
    if(currentMode==='valency') valPrompt.textContent = currentLang==='ar' ? current.name : current.en;
  }
}

// --- Save / Load ---
function saveState(){
  const st={
    xp, streak, 
    lang: currentLang,
    settings:{
      difficulty:document.getElementById('difficulty').value, 
      timeLimit:document.getElementById('timeLimit').value
    }
  }; 
  localStorage.setItem(LS_KEY,JSON.stringify(st));
}

function loadState(){
  try{
    const raw=localStorage.getItem(LS_KEY); 
    if(!raw) return; 
    const st=JSON.parse(raw); 
    xp=st.xp||0; 
    streak=st.streak||0; 
    if(st.lang) { currentLang = st.lang; langSelect.value = st.lang; }
    if(st.settings){
      document.getElementById('difficulty').value=st.settings.difficulty||'easy'; 
      document.getElementById('timeLimit').value=st.settings.timeLimit||'12';
    } 
    updateStats(false);
  }catch(e){console.warn('load failed',e);}
}

// --- Core Game Flow ---
function updateStats(checkCelebration=true){
  streakEl.textContent=streak;
  valStreakEl.textContent=streak;
  xpEl.textContent=xp;
  
  let oldRank = rankEl.textContent;
  let rObj = tiers[0];
  for(let i=tiers.length-1;i>=0;i--){if(xp>=tiers[i].xp){rObj=tiers[i]; break;}}
  
  const rankName = currentLang === 'ar' ? rObj.name : rObj.en;
  rankEl.textContent = rankName;

  if(checkCelebration && oldRank !== '...' && rankName !== oldRank){
    showCelebration(rankName);
  }
}

function showCelebration(rankName){
  clearAllTimers();
  const t = dictionary[currentLang];
  document.getElementById('celText').innerHTML = t.cel + "<br><strong style='font-size:7vh;display:block;margin-top:2vh'>" + rankName + "</strong>";
  celebration.classList.add('show');
  setTimeout(()=>{
    celebration.classList.remove('show'); 
    if(currentMode==='quiz') startQuizTimer();
    if(currentMode==='valency') startValTimer();
  },2500);
}

function showMenu(){
  clearAllTimers();
  menu.classList.remove('hidden'); 
  game.classList.add('hidden'); 
  hideAllModes(); 
  currentMode=null; 
  timerEl.textContent = '--';
  valTimerEl.textContent = '--';
}

function showGame(){
  menu.classList.add('hidden'); 
  game.classList.remove('hidden');
}

function hideAllModes(){
  quizDiv.classList.add('hidden'); 
  valDiv.classList.add('hidden');
}

// --- Quiz Mode ---
function startQuiz(){
  clearAllTimers();
  quizList = getGameElements();
  shuffle(quizList); 
  quizIndex=0; 
  nextQuiz();
}

function nextQuiz(){
  clearAllTimers();
  if(quizIndex>=quizList.length){ quizList = getGameElements(); shuffle(quizList); quizIndex=0; }
  
  const el=quizList[quizIndex]; 
  current=el; 
  qName.textContent = currentLang==='ar' ? el.name : el.en;
  
  answerInput.value=''; 
  timeLeft=parseInt(document.getElementById('timeLimit').value); 
  timerEl.textContent=timeLeft; 
  timebar.style.width='100%'; 
  timebar.style.transition = 'width 1s linear';
  startQuizTimer();
  answerInput.focus();
}

function startQuizTimer(){
  clearAllTimers();
  activeTimer = setInterval(()=>{
    timeLeft--; 
    timerEl.textContent=timeLeft; 
    const totalTime = parseInt(document.getElementById('timeLimit').value);
    timebar.style.width=((timeLeft/totalTime)*100)+'%';
    
    if(timeLeft<=0){
      clearAllTimers(); 
      showLose(current.symbol);
    }
  },1000);
}

function submitQuizAnswer(){
  const ans=answerInput.value.trim(); 
  if(!ans) return; 
  const correct=ans.toUpperCase()===current.symbol.toUpperCase(); 
  if(correct){
    correctSound.play(); 
    streak++; 
    const pts = calculateXP();
    xp+=pts; 
    
    // Animation logic
    const rect = answerInput.getBoundingClientRect();
    showFloatingXP(pts, rect.left + rect.width/2, rect.top);

    quizIndex++; 
    updateStats(); 
    saveState(); 
    nextQuiz();
  } else {
    wrongSound.play(); 
    streak=0; 
    xp=Math.max(0,xp-5); 
    updateStats();
    showLose(current.symbol);
  } 
}

// --- Valency Mode ---
function startValency(){
  clearAllTimers();
  valList=getGameElements();
  shuffle(valList); 
  valIndex=0; 
  nextVal();
}

function nextVal(){
  clearAllTimers();
  if(valIndex>=valList.length){ valList=getGameElements(); shuffle(valList); valIndex=0; }
  
  const el=valList[valIndex]; 
  current=el; 
  valPrompt.textContent = currentLang==='ar' ? el.name : el.en;
  
  valAnswer.value=''; 
  timeLeft=parseInt(document.getElementById('timeLimit').value); 
  valTimerEl.textContent=timeLeft; 
  valTimebar.style.width='100%'; 
  startValTimer();
  valAnswer.focus();
}

function startValTimer(){
  clearAllTimers();
  activeTimer = setInterval(()=>{
    timeLeft--; 
    valTimerEl.textContent=timeLeft; 
    const totalTime = parseInt(document.getElementById('timeLimit').value);
    valTimebar.style.width=((timeLeft/totalTime)*100)+'%';
    
    if(timeLeft<=0){
      clearAllTimers(); 
      showLose(current.val.join(' / '));
    }
  },1000);
}

function submitValAnswer(){
  const ans=normalizeValInput(valAnswer.value); 
  if(ans && valAcceptedFor(current,ans)){
    correctSound.play(); 
    streak++; 
    const pts = calculateXP();
    xp+=pts; 
    
    // Animation logic
    const rect = valAnswer.getBoundingClientRect();
    showFloatingXP(pts, rect.left + rect.width/2, rect.top);

    valIndex++; 
    updateStats(); 
    saveState(); 
    nextVal();
  } else {
    wrongSound.play(); 
    streak=0; 
    xp=Math.max(0,xp-5); 
    updateStats();
    showLose(current.val.join(' / '));
  } 
}

// --- Lose Screen ---
function showLose(correctStr){
  clearAllTimers();
  loseAnswerEl.textContent=correctStr; 
  loseScreen.classList.add('show'); 
  setTimeout(()=>{
    loseScreen.classList.remove('show'); 
    if(currentMode==='quiz') { quizIndex++; nextQuiz(); }
    else if(currentMode==='valency') { valIndex++; nextVal(); }
  },2500);
}

// --- Events ---
menuQuiz.onclick=()=>{
  clearAllTimers();
  showGame(); 
  hideAllModes(); 
  quizDiv.classList.remove('hidden'); 
  currentMode='quiz'; 
  startQuiz();
};

menuVal.onclick=()=>{
  clearAllTimers();
  showGame(); 
  hideAllModes(); 
  valDiv.classList.remove('hidden'); 
  currentMode='valency'; 
  startValency();
};

backMenu.onclick=()=>{
  clearAllTimers();
  showMenu();
};

clearSaveBtn.onclick=()=>{localStorage.removeItem(LS_KEY); location.reload();}
toggleMode.onchange=()=>{document.body.classList.toggle('light',toggleMode.checked);}
langSelect.onchange=()=>{
  currentLang = langSelect.value;
  applyLanguage();
  saveState();
};

submitBtn.onclick=submitQuizAnswer; 
answerInput.addEventListener('keydown',e=>{if(e.key==='Enter') submitQuizAnswer();});

valSubmit.onclick=submitValAnswer; 
valAnswer.addEventListener('keydown',e=>{if(e.key==='Enter') submitValAnswer();});

// --- Initialization ---
loadState();
applyLanguage();
showMenu();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±</title>
<style>
:root{
  --bg-dark:#0f1720; --bg-light:#f5f5f5;
  --card-dark:#111827; --card-light:#fff;
  --text-dark:#fff; --text-light:#042;
  --muted-dark:#9ca3af; --muted-light:#555;
  --accent:#06b6d4; --ok:#10b981; --bad:#ef4444;
}
html,body{margin:0; padding:0; width:100%; height:100%; font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial; background:var(--bg-dark); color:var(--text-dark); transition: background 0.3s, color 0.3s;}
body.light{background:var(--bg-light); color:var(--text-light);}
/* LTR support for English */
html[lang="en"] { direction: ltr; }

/* MAIN LAYOUT UPDATES */
.wrap{
  width:100%; 
  min-height:100vh; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  justify-content:flex-start; 
  padding: 4vh 5vw; /* More side padding */
  box-sizing:border-box; 
  overflow-y:auto;
}

h1{text-align:center; margin:1vh 0 4vh; font-size:5vh;}

/* Buttons: Bigger and more spaced */
button{cursor:pointer; border:0; border-radius:12px; padding:15px 30px; font-size:2.5vh; font-weight:bold; transition: transform 0.1s; margin: 5px;}
button:active{transform:scale(0.98);}
.primary{background:var(--accent); color:#042; box-shadow:0 4px 10px rgba(6,182,212,.3);}
.danger{background:var(--bad); color:#fff;}

.hidden{display:none !important;}

/* CARD UPDATES: Wider and more padding */
.card{
  background:rgba(255,255,255,0.02); 
  border-radius:16px; 
  margin-top:2vh; 
  border:2px solid rgba(255,255,255,0.05); 
  width:100%; 
  padding: 40px; /* Lots of breathing room */
  box-sizing:border-box; 
  font-size:3vh;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

/* Controls (Rank/Time/Diff) - Spaced out nicely */
.controls{
  display:flex; 
  flex-wrap:wrap; 
  justify-content:space-between; 
  gap: 20px; /* Space between items */
  margin: 3vh 0; 
  font-size:2.2vh; 
  width: 100%;
  padding: 0 10px;
}
.row{display:flex; align-items:center; gap: 10px;}

/* Inputs: Full width and taller */
input[type="text"]{
  padding:20px; 
  font-size:3.5vh; 
  border-radius:12px; 
  border:2px solid var(--accent); 
  width:100%; 
  box-sizing:border-box; 
  text-align:center;
  background: rgba(255,255,255,0.05);
  color: inherit;
  margin-bottom: 20px;
}
input[type="text"]:focus{ outline:none; background: rgba(255,255,255,0.1); }

select{padding:8px 15px; font-size:2.2vh; border-radius:8px; border:0; cursor:pointer;}

.progress{height:20px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; width: 100%;}
.bar{height:100%; background:linear-gradient(90deg,#06b6d4,#10b981); width:0%; transition: width 1s linear;}
.rank{padding:5px 15px; border-radius:20px; font-size:2.2vh; background:rgba(255,255,255,0.1); display:inline-block;}

/* Screen Containers */
#menu{text-align:center; width:100%; max-width: 600px;}
#menu button{width:100%; margin:1.5vh 0; padding: 25px;}

/* Game Container - Allows more width now */
#game { width: 100%; max-width: 900px; display: flex; flex-direction: column; align-items: center; }

body.light .card{background:#fff; border:2px solid #e5e7eb; box-shadow: 0 10px 30px rgba(0,0,0,0.05);}
body.light button{background:var(--card-light); color:var(--text-light); border: 1px solid #ddd;}
body.light .primary{background:var(--accent); color:#fff; border:none;}
body.light .danger{background:var(--bad); color:#fff; border:none;}
body.light input[type="text"]{background: #fff; border: 2px solid #ccc; color: #333;}

#loseScreen{position:fixed; top:0; left:0; width:100vw; height:100vh; background:linear-gradient(135deg,#3b0b0b,#7f1d1d); display:flex; align-items:center; justify-content:center; flex-direction:column; font-size:4vh; color:#fff; z-index:999; text-align:center; opacity:0; pointer-events:none; transition:opacity .25s;}
#loseScreen.show{opacity:1; pointer-events:auto;}

#celebration{position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:5vh; color:#10b981; z-index:1000; text-align:center; opacity:0; pointer-events:none; transition:opacity 0.3s; padding: 20px;}
#celebration.show{opacity:1; pointer-events:auto;}

.settings-row { display: flex; justify-content: center; gap: 30px; margin-top: 4vh; align-items: center;}
.header-row { display:flex; justify-content:space-between; align-items:center; font-size:2.2vh; margin-bottom: 20px; color: var(--muted-dark); }
body.light .header-row { color: var(--muted-light); }
</style>
</head>
<body>
<div class="wrap">
  <div id="menu">
    <h1 id="titleText">âš›ï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±</h1>
    <button id="menuQuiz" class="primary">ğŸ§ª ØªØ­Ø¯ÙŠ Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ù†Ø§ØµØ±</button>
    <button id="menuVal" class="primary">âš–ï¸ ØªØ­Ø¯ÙŠ ØªÙƒØ§ÙØ¤Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±</button>
    
    <div style="margin-top:4vh">
      <button id="clearSave" class="danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­ÙØ¸ (Reset)</button>
    </div>
    
    <div class="settings-row">
       <label style="cursor:pointer"><input id="toggleMode" type="checkbox"> <span id="lblMode">Ù†Ù‡Ø§Ø±/Ù„ÙŠÙ„</span></label>
       <label style="cursor:pointer"><input id="toggleLang" type="checkbox"> <span id="lblLang">English</span></label>
    </div>
  </div>

  <div id="game" class="hidden">
    <div style="width:100%; display:flex; justify-content:flex-start;">
      <button id="backMenu" class="danger" style="padding: 10px 20px; font-size: 2vh;">â¬… <span id="txtBack">Ø§Ù„Ø¹ÙˆØ¯Ø©</span></button>
    </div>

    <div class="controls">
      <div class="row"><span id="lblDiff">Ø§Ù„ØµØ¹ÙˆØ¨Ø©</span>:
        <select id="difficulty">
          <option value="easy" id="optEasy">Ø³Ù‡Ù„</option>
          <option value="medium" selected id="optMed">Ù…ØªÙˆØ³Ø·</option>
          <option value="hard" id="optHard">ØµØ¹Ø¨</option>
        </select>
      </div>
      <div class="row"><span id="lblTime">Ø§Ù„ÙˆÙ‚Øª</span>:
        <select id="timeLimit">
          <option value="8">8s</option>
          <option value="12" selected>12s</option>
          <option value="20">20s</option>
        </select>
      </div>
      <div class="row"><span id="lblXP">Ø®Ø¨Ø±Ø©</span>: <span id="xp" style="color:var(--accent); font-weight:bold;">0</span></div>
      <div class="row"><span id="lblRank">Ø±ØªØ¨Ø©</span>: <span id="rank" class="rank">...</span></div>
    </div>

    <div id="quiz" class="card hidden">
      <div class="header-row">
        <div id="quizHeader">ğŸ§ª Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø²</div>
        <div><span id="quizTimerLbl">Ø§Ù„ÙˆÙ‚Øª</span>: <span id="timer" style="font-family:monospace; font-weight:bold;">--</span></div>
      </div>
      
      <div id="quizInfo" style="text-align:center; font-size:6vh; margin: 3vh 0;">
        <div id="qName" style="font-weight:800; color:var(--accent); text-shadow: 0 0 20px rgba(6,182,212,0.2);">â€”</div>
      </div>
      
      <div style="width:100%">
        <input id="answer" placeholder="Symbol (e.g. H)" autocomplete="off" />
        <button id="submit" class="primary" style="width:100%">âœ” <span id="btnCheck1">ØªØ­Ù‚Ù‚</span></button>
      </div>

      <div style="margin-top:3vh; display:flex; justify-content:space-between; align-items:center; gap:20px;">
        <div style="white-space:nowrap;"><span id="streakLbl1">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</span>: <span id="streak" style="font-weight:bold; color:var(--ok)">0</span></div>
        <div style="flex-grow:1;"><div class="progress"><div id="timebar" class="bar"></div></div></div>
      </div>
    </div>

    <div id="valency" class="card hidden">
      <div class="header-row">
        <div id="valHeader">âš–ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´Ø­Ù†Ø©</div>
        <div><span id="valTimerLbl">Ø§Ù„ÙˆÙ‚Øª</span>: <span id="valTimer" style="font-family:monospace; font-weight:bold;">--</span></div>
      </div>

      <div id="valInfo" style="text-align:center; font-size:6vh; margin: 3vh 0;">
        <div id="valPrompt" style="font-weight:800; color:var(--accent); text-shadow: 0 0 20px rgba(6,182,212,0.2);">â€”</div>
        <div class="small-muted" style="margin-top:1vh; font-size:2.2vh; opacity:0.6; font-weight:normal;" id="valNote">(Ø¨Ø¯ÙˆÙ† Ø¥Ø´Ø§Ø±Ø© = Ù…ÙˆØ¬Ø¨)</div>
      </div>

      <div style="width:100%">
        <input id="valAnswer" placeholder="+1, -2, 0" autocomplete="off" />
        <button id="valSubmit" class="primary" style="width:100%">âœ” <span id="btnCheck2">ØªØ­Ù‚Ù‚</span></button>
      </div>

      <div style="margin-top:3vh; display:flex; justify-content:space-between; align-items:center; gap:20px;">
        <div style="white-space:nowrap;"><span id="streakLbl2">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</span>: <span id="valStreak" style="font-weight:bold; color:var(--ok)">0</span></div>
        <div style="flex-grow:1;"><div class="progress"><div id="valTimebar" class="bar"></div></div></div>
      </div>
    </div>

  </div>
</div>

<div id="loseScreen">
  <div id="loseText">
    <div style="margin-bottom:20px">âŒ <span id="txtWrong">Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!</span></div>
    <div style="font-size:3vh"><span id="txtCorrectIs">Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ</span>: <strong id="loseAnswer" style="color:#4ade80; font-size:8vh; display:block; margin-top:20px"></strong></div>
  </div>
</div>

<div id="celebration"><span id="celText">ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!</span></div>

<script>
// --- Data ---
const elements=[
{symbol:'H',name:'Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ†',en:'Hydrogen',val:['+1']},
{symbol:'He',name:'Ø§Ù„Ù‡ÙŠÙ„ÙŠÙˆÙ…',en:'Helium',val:['0']},
{symbol:'Li',name:'Ø§Ù„Ù„ÙŠØ«ÙŠÙˆÙ…',en:'Lithium',val:['+1']},
{symbol:'Be',name:'Ø§Ù„Ø¨ÙŠØ±ÙŠÙ„ÙŠÙˆÙ…',en:'Beryllium',val:['+2']},
{symbol:'B',name:'Ø§Ù„Ø¨ÙˆØ±ÙˆÙ†',en:'Boron',val:['+3']},
{symbol:'C',name:'Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†',en:'Carbon',val:['+4','-4']},
{symbol:'N',name:'Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†',en:'Nitrogen',val:['+5','-3']},
{symbol:'O',name:'Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†',en:'Oxygen',val:['-2']},
{symbol:'F',name:'Ø§Ù„ÙÙ„ÙˆØ±',en:'Fluorine',val:['-1']},
{symbol:'Ne',name:'Ø§Ù„Ù†ÙŠÙˆÙ†',en:'Neon',val:['0']},
{symbol:'Na',name:'Ø§Ù„ØµÙˆØ¯ÙŠÙˆÙ…',en:'Sodium',val:['+1']},
{symbol:'Mg',name:'Ø§Ù„Ù…ØºÙ†ÙŠØ³ÙŠÙˆÙ…',en:'Magnesium',val:['+2']},
{symbol:'Al',name:'Ø§Ù„Ø£Ù„Ù…Ù†ÙŠÙˆÙ…',en:'Aluminium',val:['+3']},
{symbol:'Si',name:'Ø§Ù„Ø³ÙŠÙ„ÙŠÙƒÙˆÙ†',en:'Silicon',val:['+4','-4']},
{symbol:'P',name:'Ø§Ù„ÙØ³ÙÙˆØ±',en:'Phosphorus',val:['+5','-3']},
{symbol:'S',name:'Ø§Ù„ÙƒØ¨Ø±ÙŠØª',en:'Sulfur',val:['-2','+6']},
{symbol:'Cl',name:'Ø§Ù„ÙƒÙ„ÙˆØ±',en:'Chlorine',val:['-1','+1','+5','+7']},
{symbol:'Ar',name:'Ø§Ù„Ø£Ø±Ø¬ÙˆÙ†',en:'Argon',val:['0']},
{symbol:'K',name:'Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…',en:'Potassium',val:['+1']},
{symbol:'Ca',name:'Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ…',en:'Calcium',val:['+2']}
];

// --- Translation Dictionary ---
const dictionary = {
  ar: {
    title: "âš›ï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±",
    btnQuiz: "ğŸ§ª ØªØ­Ø¯ÙŠ Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ù†Ø§ØµØ±",
    btnVal: "âš–ï¸ ØªØ­Ø¯ÙŠ ØªÙƒØ§ÙØ¤Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±",
    reset: "ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­ÙØ¸",
    mode: "Ù†Ù‡Ø§Ø±/Ù„ÙŠÙ„",
    back: "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©",
    diff: "Ø§Ù„ØµØ¹ÙˆØ¨Ø©",
    time: "Ø§Ù„ÙˆÙ‚Øª",
    xp: "Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø©",
    rank: "Ø§Ù„Ø±ØªØ¨Ø©",
    easy: "Ø³Ù‡Ù„", med: "Ù…ØªÙˆØ³Ø·", hard: "ØµØ¹Ø¨",
    qHeader: "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØŸ",
    phSym: "Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§ (Ù…Ø«Ø§Ù„: H)",
    check: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
    streak: "ğŸ”¥ ØªØªØ§Ø¨Ø¹",
    vHeader: "Ù…Ø§ Ù‡Ùˆ ØªÙƒØ§ÙØ¤ Ø§Ù„Ø¹Ù†ØµØ±ØŸ",
    vNote: "(Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¯ÙˆÙ† Ø¥Ø´Ø§Ø±Ø© ÙŠØ­Ø³Ø¨ Ù…ÙˆØ¬Ø¨)",
    wrong: "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!",
    correctIs: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ",
    cel: "ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø±ØªØ¨Ø©:",
    langBtn: "English"
  },
  en: {
    title: "âš›ï¸ Elements Game",
    btnQuiz: "ğŸ§ª Symbol Challenge",
    btnVal: "âš–ï¸ Valency Challenge",
    reset: "ğŸ—‘ï¸ Reset Save",
    mode: "Day/Night",
    back: "Main Menu",
    diff: "Diff",
    time: "Time",
    xp: "XP",
    rank: "Rank",
    easy: "Easy", med: "Med", hard: "Hard",
    qHeader: "What is the Symbol?",
    phSym: "Type symbol here (e.g. H)",
    check: "Submit Answer",
    streak: "ğŸ”¥ Streak",
    vHeader: "What is the Valency?",
    vNote: "(Note: No sign = Positive)",
    wrong: "Wrong Answer!",
    correctIs: "The correct answer is:",
    cel: "ğŸ‰ Congrats! New Rank:",
    langBtn: "Ø¹Ø±Ø¨ÙŠ"
  }
};

const tiers=[
  {xp:0,name:'Ù…ØªØ¹Ù„Ù… Ù…Ø¨ØªØ¯Ø¦', en:'Novice Learner'},
  {xp:50,name:'Ù…ØªØ¹Ù„Ù… Ù…ØªÙ‚Ø¯Ù…', en:'Advanced Learner'},
  {xp:150,name:'Ø®Ø¨ÙŠØ± Ø§Ù„Ø¹Ù†Ø§ØµØ±', en:'Element Expert'},
  {xp:300,name:'Ù…Ø§ÙŠØ³ØªØ±Ùˆ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', en:'Chemistry Maestro'},
  {xp:600,name:'Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø®Ø§Ø±Ù‚', en:'Super Master'},
  {xp:1500,name:'Ø³ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø²ÙŠÙ', en:'Fake Master'}
];

// --- Globals & DOM ---
let currentLang = 'ar';
const LS_KEY='periodic_game_v5_wide';

const menu=document.getElementById('menu'), game=document.getElementById('game');
const menuQuiz=document.getElementById('menuQuiz'), menuVal=document.getElementById('menuVal');
const backMenu=document.getElementById('backMenu'), clearSaveBtn=document.getElementById('clearSave');
const toggleMode=document.getElementById('toggleMode'), toggleLang=document.getElementById('toggleLang');
const quizDiv=document.getElementById('quiz'), qName=document.getElementById('qName'), timerEl=document.getElementById('timer'), answerInput=document.getElementById('answer'), submitBtn=document.getElementById('submit'), streakEl=document.getElementById('streak'), xpEl=document.getElementById('xp'), rankEl=document.getElementById('rank'), timebar=document.getElementById('timebar');
const valDiv=document.getElementById('valency'), valPrompt=document.getElementById('valPrompt'), valTimerEl=document.getElementById('valTimer'), valAnswer=document.getElementById('valAnswer'), valSubmit=document.getElementById('valSubmit'), valStreakEl=document.getElementById('valStreak'), valTimebar=document.getElementById('valTimebar');
const loseScreen=document.getElementById('loseScreen'), loseAnswerEl=document.getElementById('loseAnswer');
const celebration=document.getElementById('celebration');

let xp=0, streak=0, current=null, quizList=[], quizIndex=0, valList=[], valIndex=0, timer=null, timeLeft=0, currentMode=null;
const correctSound=new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
const wrongSound=new Audio('https://assets.mixkit.co/sfx/preview/mixkit-wrong-buzz-907.mp3');

// --- Helper Functions ---
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}
function clearRunningTimer(){if(timer){clearInterval(timer); timer=null;}}
function normalizeValInput(s){if(!s) return null;s=s.toString().trim().replace(/\s+/g,'');if(/^[+-]?\d+$/.test(s)){if(s==='0'||s==='+0'||s==='-0')return'0'; if(/^[+-]/.test(s))return (s[0]==='+')?('+'+parseInt(s,10)):'-'+Math.abs(parseInt(s,10)); return '+'+parseInt(s,10);} return null;}
function valAcceptedFor(elem,answerNormalized){if(!elem||!elem.val)return false; return elem.val.some(v=>{if(v==='0')return answerNormalized==='0'; return v===answerNormalized;});}

// --- Localization Logic ---
function applyLanguage(){
  const t = dictionary[currentLang];
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
  
  // Update Menu
  document.getElementById('titleText').textContent = t.title;
  menuQuiz.textContent = t.btnQuiz;
  menuVal.textContent = t.btnVal;
  clearSaveBtn.textContent = t.reset;
  document.getElementById('lblMode').textContent = t.mode;
  document.getElementById('lblLang').textContent = t.langBtn;
  
  // Update Game UI
  document.getElementById('txtBack').textContent = t.back;
  document.getElementById('lblDiff').textContent = t.diff;
  document.getElementById('lblTime').textContent = t.time;
  document.getElementById('lblXP').textContent = t.xp;
  document.getElementById('lblRank').textContent = t.rank;
  document.getElementById('optEasy').textContent = t.easy;
  document.getElementById('optMed').textContent = t.med;
  document.getElementById('optHard').textContent = t.hard;
  
  // Quiz Specific
  document.getElementById('quizHeader').textContent = t.qHeader;
  answerInput.placeholder = t.phSym;
  document.getElementById('btnCheck1').textContent = t.check;
  document.getElementById('streakLbl1').textContent = t.streak;
  document.getElementById('quizTimerLbl').textContent = t.time;

  // Valency Specific
  document.getElementById('valHeader').textContent = t.vHeader;
  document.getElementById('valNote').textContent = t.vNote;
  document.getElementById('btnCheck2').textContent = t.check;
  document.getElementById('streakLbl2').textContent = t.streak;
  document.getElementById('valTimerLbl').textContent = t.time;

  // Lose Screen
  document.getElementById('txtWrong').textContent = t.wrong;
  document.getElementById('txtCorrectIs').textContent = t.correctIs;

  updateStats(false);
  
  if(current){
    if(currentMode==='quiz') qName.textContent = currentLang==='ar' ? current.name : current.en;
    if(currentMode==='valency') valPrompt.textContent = currentLang==='ar' ? current.name : current.en;
  }
}

// --- Save / Load ---
function saveState(){
  const st={
    xp, streak, 
    lang: currentLang,
    settings:{
      difficulty:document.getElementById('difficulty').value, 
      timeLimit:document.getElementById('timeLimit').value
    }
  }; 
  localStorage.setItem(LS_KEY,JSON.stringify(st));
}

function loadState(){
  try{
    const raw=localStorage.getItem(LS_KEY); 
    if(!raw) return; 
    const st=JSON.parse(raw); 
    xp=st.xp||0; 
    streak=st.streak||0; 
    if(st.lang) { currentLang = st.lang; toggleLang.checked = (st.lang === 'en'); }
    if(st.settings){
      document.getElementById('difficulty').value=st.settings.difficulty||'medium'; 
      document.getElementById('timeLimit').value=st.settings.timeLimit||'12';
    } 
    updateStats(false);
  }catch(e){console.warn('load failed',e);}
}

// --- Core Game Flow ---
function updateStats(checkCelebration=true){
  streakEl.textContent=streak;
  valStreakEl.textContent=streak;
  xpEl.textContent=xp;
  
  let oldRank = rankEl.textContent;
  let rObj = tiers[0];
  for(let i=tiers.length-1;i>=0;i--){if(xp>=tiers[i].xp){rObj=tiers[i]; break;}}
  
  const rankName = currentLang === 'ar' ? rObj.name : rObj.en;
  rankEl.textContent = rankName;

  if(checkCelebration && oldRank !== '...' && rankName !== oldRank){
    showCelebration(rankName);
  }
}

function showCelebration(rankName){
  clearRunningTimer();
  const t = dictionary[currentLang];
  document.getElementById('celText').innerHTML = t.cel + "<br><strong style='font-size:7vh;display:block;margin-top:2vh'>" + rankName + "</strong>";
  celebration.classList.add('show');
  setTimeout(()=>{
    celebration.classList.remove('show'); 
    if(currentMode==='quiz') startQuizTimer();
    if(currentMode==='valency') startValTimer();
  },2500);
}

function showMenu(){
  menu.classList.remove('hidden'); 
  game.classList.add('hidden'); 
  hideAllModes(); 
  currentMode=null; 
  clearRunningTimer();
}

function showGame(){
  menu.classList.add('hidden'); 
  game.classList.remove('hidden');
}

function hideAllModes(){
  quizDiv.classList.add('hidden'); 
  valDiv.classList.add('hidden');
}

// --- Quiz Mode ---
function startQuiz(){
  quizList=elements.slice(); 
  shuffle(quizList); 
  quizIndex=0; 
  nextQuiz();
}

function nextQuiz(){
  clearRunningTimer();
  if(quizIndex>=quizList.length){ quizList=elements.slice(); shuffle(quizList); quizIndex=0; }
  
  const el=quizList[quizIndex]; 
  current=el; 
  qName.textContent = currentLang==='ar' ? el.name : el.en;
  
  answerInput.value=''; 
  timeLeft=parseInt(document.getElementById('timeLimit').value); 
  timerEl.textContent=timeLeft; 
  timebar.style.width='100%'; 
  timebar.style.transition = 'width 1s linear';
  startQuizTimer();
  answerInput.focus();
}

function startQuizTimer(){
  timer= setInterval(()=>{
    timeLeft--; 
    timerEl.textContent=timeLeft; 
    const totalTime = parseInt(document.getElementById('timeLimit').value);
    timebar.style.width=((timeLeft/totalTime)*100)+'%';
    
    if(timeLeft<=0){
      clearRunningTimer(); 
      showLose(current.symbol);
    }
  },1000);
}

function submitQuizAnswer(){
  const ans=answerInput.value.trim(); 
  if(!ans) return; 
  const correct=ans.toUpperCase()===current.symbol.toUpperCase(); 
  if(correct){
    correctSound.play(); 
    streak++; 
    xp+=10; 
    quizIndex++; 
    updateStats(); 
    saveState(); 
    nextQuiz();
  } else {
    wrongSound.play(); 
    streak=0; 
    xp=Math.max(0,xp-5); 
    updateStats();
    showLose(current.symbol);
  } 
}

// --- Valency Mode ---
function startValency(){
  valList=elements.slice(); 
  shuffle(valList); 
  valIndex=0; 
  nextVal();
}

function nextVal(){
  clearRunningTimer();
  if(valIndex>=valList.length){ valList=elements.slice(); shuffle(valList); valIndex=0; }
  
  const el=valList[valIndex]; 
  current=el; 
  valPrompt.textContent = currentLang==='ar' ? el.name : el.en;
  
  valAnswer.value=''; 
  timeLeft=parseInt(document.getElementById('timeLimit').value); 
  valTimerEl.textContent=timeLeft; 
  valTimebar.style.width='100%'; 
  startValTimer();
  valAnswer.focus();
}

function startValTimer(){
  timer= setInterval(()=>{
    timeLeft--; 
    valTimerEl.textContent=timeLeft; 
    const totalTime = parseInt(document.getElementById('timeLimit').value);
    valTimebar.style.width=((timeLeft/totalTime)*100)+'%';
    
    if(timeLeft<=0){
      clearRunningTimer(); 
      showLose(current.val.join(' / '));
    }
  },1000);
}

function submitValAnswer(){
  const ans=normalizeValInput(valAnswer.value); 
  if(ans && valAcceptedFor(current,ans)){
    correctSound.play(); 
    streak++; 
    xp+=10; 
    valIndex++; 
    updateStats(); 
    saveState(); 
    nextVal();
  } else {
    wrongSound.play(); 
    streak=0; 
    xp=Math.max(0,xp-5); 
    updateStats();
    showLose(current.val.join(' / '));
  } 
}

// --- Lose Screen ---
function showLose(correctStr){
  clearRunningTimer();
  loseAnswerEl.textContent=correctStr; 
  loseScreen.classList.add('show'); 
  setTimeout(()=>{
    loseScreen.classList.remove('show'); 
    if(currentMode==='quiz') { quizIndex++; nextQuiz(); }
    else if(currentMode==='valency') { valIndex++; nextVal(); }
  },2500);
}

// --- Events ---
menuQuiz.onclick=()=>{
  showGame(); 
  hideAllModes(); 
  quizDiv.classList.remove('hidden'); 
  currentMode='quiz'; 
  startQuiz();
};

menuVal.onclick=()=>{
  showGame(); 
  hideAllModes(); 
  valDiv.classList.remove('hidden'); 
  currentMode='valency'; 
  startValency();
};

backMenu.onclick=()=>showMenu();
clearSaveBtn.onclick=()=>{localStorage.removeItem(LS_KEY); location.reload();}
toggleMode.onchange=()=>{document.body.classList.toggle('light',toggleMode.checked);}
toggleLang.onchange=()=>{
  currentLang = toggleLang.checked ? 'en' : 'ar';
  applyLanguage();
  saveState();
};

submitBtn.onclick=submitQuizAnswer; 
answerInput.addEventListener('keydown',e=>{if(e.key==='Enter') submitQuizAnswer();});

valSubmit.onclick=submitValAnswer; 
valAnswer.addEventListener('keydown',e=>{if(e.key==='Enter') submitValAnswer();});

// --- Initialization ---
loadState();
applyLanguage();
showMenu();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ØªÙƒØ§ÙØ¤Ø§Øª</title>
<style>
:root{
  --bg-dark:#0f172a; --bg-light:#f8fafc;
  --card-dark:#1e293b; --card-light:#ffffff;
  --text-dark:#e2e8f0; --text-light:#0f172a;
  --accent:#06b6d4; --ok:#10b981; --bad:#ef4444;
}

/* UPGRADED BACKGROUND: 
   Uses a distinct Benzene Ring SVG pattern + Radial Gradients 
*/
body {
  margin:0; padding:0; width:100%; height:100%; 
  font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial; 
  transition: background 0.3s, color 0.3s;
  background-color: var(--bg-dark);
  color: var(--text-dark);
  /* The SVG below is a repeating chemical structure pattern */
  background-image: 
    radial-gradient(circle at 10% 20%, rgba(6, 182, 212, 0.2), transparent 40%), 
    radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.2), transparent 40%),
    url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%23334155' stroke-width='2' stroke-opacity='0.4'%3E%3Cpath d='M50 20 L76 35 L76 65 L50 80 L24 65 L24 35 Z' /%3E%3Cpath d='M50 20 L50 0 M76 35 L95 25 M76 65 L95 75 M50 80 L50 100 M24 65 L5 75 M24 35 L5 25' /%3E%3Ccircle cx='50' cy='50' r='12' stroke='%2306b6d4' stroke-width='1' stroke-opacity='0.2'/%3E%3C/g%3E%3C/svg%3E");
  background-size: 100% 100%, 100% 100%, 120px 120px; /* SVG size increased */
}

body.light {
  background-color: var(--bg-light);
  color: var(--text-light);
  /* Light mode version of the chemical structures */
  background-image: 
    radial-gradient(circle at 10% 20%, rgba(6, 182, 212, 0.1), transparent 40%), 
    url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%23cbd5e1' stroke-width='2'%3E%3Cpath d='M50 20 L76 35 L76 65 L50 80 L24 65 L24 35 Z' /%3E%3Cpath d='M50 20 L50 0 M76 35 L95 25 M76 65 L95 75 M50 80 L50 100 M24 65 L5 75 M24 35 L5 25' /%3E%3Ccircle cx='50' cy='50' r='12' stroke='%2306b6d4' stroke-width='1' stroke-opacity='0.1'/%3E%3C/g%3E%3C/svg%3E");
}

html[lang="en"] { direction: ltr; }

.wrap{
  width:100%; 
  min-height:100vh; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  justify-content:flex-start; 
  padding: 2vh 2vw; /* Reduced side padding to allow wider content */
  box-sizing:border-box; 
  overflow-y:auto;
}

h1 {
  text-align:center; 
  margin:2vh 0 4vh; 
  font-size: 6vh; 
  font-weight: 900;
  text-shadow: 0 4px 15px rgba(0,0,0,0.5);
  line-height: 1.2;
}

button{cursor:pointer; border:0; border-radius:16px; padding:20px 30px; font-size:2.8vh; font-weight:bold; transition: transform 0.1s, box-shadow 0.2s; margin: 8px;}
button:active{transform:scale(0.97);}
.primary{background:linear-gradient(135deg, var(--accent), #0891b2); color:#fff; box-shadow:0 4px 15px rgba(6,182,212,0.4);}
.danger{background:var(--bad); color:#fff;}

.hidden{display:none !important;}

/* WIDER CARD */
.card{
  background:var(--card-dark); 
  border-radius:24px; 
  margin-top:2vh; 
  border:1px solid rgba(255,255,255,0.1); 
  width:100%; 
  padding: 30px; /* Reduced internal padding slightly */
  box-sizing:border-box; 
  font-size:3vh;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
  backdrop-filter: blur(10px); /* Glassmorphism effect */
}

/* WIDER CONTROLS BAR */
.controls{
  display:flex; flex-wrap:wrap; justify-content:space-between; 
  gap: 15px; margin: 2vh 0; font-size:2.2vh; width: 100%;
}
.row{display:flex; align-items:center; gap: 10px; background:rgba(0,0,0,0.3); padding:10px 20px; border-radius:12px; border: 1px solid rgba(255,255,255,0.05);}

/* MASSIVE INPUT FIELD UPGRADE */
input[type="text"]{
  display: block; /* Ensure it takes full width */
  padding: 20px; 
  height: 100px; /* Fixed massive height */
  font-size: 6vh; /* Huge text */
  font-weight: 900;
  letter-spacing: 2px;
  border-radius:16px; 
  border:4px solid var(--accent); /* Thicker border */
  width:100%; 
  box-sizing:border-box; 
  text-align:center;
  background: rgba(0,0,0,0.2);
  color: inherit;
  margin-bottom: 25px;
  box-shadow: inset 0 4px 20px rgba(0,0,0,0.3);
}
input[type="text"]:focus{ outline:none; background: rgba(0,0,0,0.4); border-color: var(--ok); box-shadow: 0 0 20px rgba(16,185,129,0.3); }

select{padding:8px 15px; font-size:2.2vh; border-radius:8px; border:0; cursor:pointer; background:var(--bg-light); color:#333; font-weight:bold;}
#langSelect { padding: 10px 20px; font-size: 2vh; border: 2px solid var(--accent); }

.progress{height:20px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; width: 100%;}
.bar{height:100%; background:linear-gradient(90deg,#06b6d4,#10b981); width:0%; transition: width 1s linear;}
.rank{padding:5px 15px; border-radius:20px; font-size:2.2vh; background:var(--accent); color:#fff; display:inline-block;}

#menu{text-align:center; width:100%; max-width: 800px;}
#menu button{width:100%; margin:2vh 0; padding: 30px; font-size: 3.5vh;}

/* CONTAINER WIDTH INCREASED */
#game { width: 100%; max-width: 1200px; display: flex; flex-direction: column; align-items: center; }

body.light .card{background:rgba(255,255,255,0.9); border:2px solid #e2e8f0; box-shadow: 0 10px 30px rgba(0,0,0,0.05);}
body.light button{border: 1px solid #ddd;} 
body.light .primary{border:none; color: #fff;}
body.light .row{background:rgba(255,255,255,0.6); border: 1px solid rgba(0,0,0,0.05);}
body.light input[type="text"]{background: #f1f5f9; border: 4px solid #cbd5e1; color: #333;}

#loseScreen{position:fixed; top:0; left:0; width:100vw; height:100vh; background:linear-gradient(135deg,#7f1d1d,#3b0b0b); display:flex; align-items:center; justify-content:center; flex-direction:column; font-size:4vh; color:#fff; z-index:999; text-align:center; opacity:0; pointer-events:none; transition:opacity .25s;}
#loseScreen.show{opacity:1; pointer-events:auto;}

#celebration{position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.98); display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:5vh; color:#10b981; z-index:1000; text-align:center; opacity:0; pointer-events:none; transition:opacity 0.3s; padding: 20px;}
#celebration.show{opacity:1; pointer-events:auto;}

.settings-row { display: flex; justify-content: center; gap: 30px; margin-top: 4vh; align-items: center;}
.header-row { display:flex; justify-content:space-between; align-items:center; font-size:2.5vh; margin-bottom: 20px; opacity: 0.8;}

.xp-popup { position: absolute; color: var(--ok); font-weight: bold; font-size: 3vh; animation: floatUp 1s ease-out forwards; pointer-events: none; z-index: 200; }
@keyframes floatUp { 0% { opacity:1; transform:translateY(0); } 100% { opacity:0; transform:translateY(-50px); } }
</style>
</head>
<body>
<div class="wrap">
  <div id="menu">
    <h1 id="titleText">âš›ï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ØªÙƒØ§ÙØ¤Ø§Øª</h1>
    <button id="menuQuiz" class="primary">ğŸ§ª ØªØ­Ø¯ÙŠ Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ù†Ø§ØµØ±</button>
    <button id="menuVal" class="primary">âš–ï¸ ØªØ­Ø¯ÙŠ ØªÙƒØ§ÙØ¤Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±</button>
    
    <div style="margin-top:4vh">
      <button id="clearSave" class="danger" style="font-size:2.2vh; padding: 15px;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­ÙØ¸ (Reset)</button>
    </div>
    
    <div class="settings-row">
       <label style="cursor:pointer; display:flex; align-items:center; gap:10px; font-size:2.2vh;">
         <input id="toggleMode" type="checkbox"> 
         <span id="lblMode">Ù†Ù‡Ø§Ø±/Ù„ÙŠÙ„</span>
       </label>
       
       <select id="langSelect">
         <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
         <option value="en">English</option>
       </select>
    </div>
  </div>

  <div id="game" class="hidden">
    <div style="width:100%; display:flex; justify-content:flex-start;">
      <button id="backMenu" class="danger" style="padding: 10px 20px; font-size: 2vh;">â¬… <span id="txtBack">Ø§Ù„Ø¹ÙˆØ¯Ø©</span></button>
    </div>

    <div class="controls">
      <div class="row"><span id="lblDiff">Ø§Ù„ØµØ¹ÙˆØ¨Ø©</span>:
        <select id="difficulty">
          <option value="easy" selected id="optEasy">Ø³Ù‡Ù„</option>
          <option value="hard" id="optHard">ØµØ¹Ø¨</option>
        </select>
      </div>
      <div class="row"><span id="lblTime">Ø§Ù„ÙˆÙ‚Øª</span>:
        <select id="timeLimit">
          <option value="8">8s (XP++)</option>
          <option value="12" selected>12s</option>
          <option value="20">20s (XP--)</option>
        </select>
      </div>
      <div class="row"><span id="lblXP">Ø®Ø¨Ø±Ø©</span>: <span id="xp" style="color:var(--accent); font-weight:bold;">0</span></div>
      <div class="row"><span id="lblRank">Ø±ØªØ¨Ø©</span>: <span id="rank" class="rank">...</span></div>
    </div>

    <div id="quiz" class="card hidden">
      <div class="header-row">
        <div id="quizHeader">ğŸ§ª Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø²</div>
        <div><span id="quizTimerLbl">Ø§Ù„ÙˆÙ‚Øª</span>: <span id="timer" style="font-family:monospace; font-weight:bold; color:var(--bad); font-size: 3vh;">--</span></div>
      </div>
      
      <div id="quizInfo" style="text-align:center; font-size:6vh; margin: 3vh 0;">
        <div id="qName" style="font-weight:900; color:var(--accent); text-shadow: 0 0 30px rgba(6,182,212,0.3);">â€”</div>
      </div>
      
      <div style="width:100%; position:relative;">
        <input id="answer" placeholder="Symbol (e.g. H)" autocomplete="off" />
        <button id="submit" class="primary" style="width:100%">âœ” <span id="btnCheck1">ØªØ­Ù‚Ù‚</span></button>
      </div>

      <div style="margin-top:3vh; display:flex; justify-content:space-between; align-items:center; gap:20px;">
        <div style="white-space:nowrap;"><span id="streakLbl1">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</span>: <span id="streak" style="font-weight:bold; color:var(--ok)">0</span></div>
        <div style="flex-grow:1;"><div class="progress"><div id="timebar" class="bar"></div></div></div>
      </div>
    </div>

    <div id="valency" class="card hidden">
      <div class="header-row">
        <div id="valHeader">âš–ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´Ø­Ù†Ø©</div>
        <div><span id="valTimerLbl">Ø§Ù„ÙˆÙ‚Øª</span>: <span id="valTimer" style="font-family:monospace; font-weight:bold; color:var(--bad); font-size: 3vh;">--</span></div>
      </div>

      <div id="valInfo" style="text-align:center; font-size:6vh; margin: 3vh 0;">
        <div id="valPrompt" style="font-weight:900; color:var(--accent); text-shadow: 0 0 30px rgba(6,182,212,0.3);">â€”</div>
        <div class="small-muted" style="margin-top:1vh; font-size:2.2vh; opacity:0.6; font-weight:normal;" id="valNote">(Ø¨Ø¯ÙˆÙ† Ø¥Ø´Ø§Ø±Ø© = Ù…ÙˆØ¬Ø¨)</div>
      </div>

      <div style="width:100%; position:relative;">
        <input id="valAnswer" placeholder="+1, -2, 0" autocomplete="off" />
        <button id="valSubmit" class="primary" style="width:100%">âœ” <span id="btnCheck2">ØªØ­Ù‚Ù‚</span></button>
      </div>

      <div style="margin-top:3vh; display:flex; justify-content:space-between; align-items:center; gap:20px;">
        <div style="white-space:nowrap;"><span id="streakLbl2">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</span>: <span id="valStreak" style="font-weight:bold; color:var(--ok)">0</span></div>
        <div style="flex-grow:1;"><div class="progress"><div id="valTimebar" class="bar"></div></div></div>
      </div>
    </div>

  </div>
</div>

<div id="loseScreen">
  <div id="loseText">
    <div style="margin-bottom:20px">âŒ <span id="txtWrong">Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!</span></div>
    <div style="font-size:3vh"><span id="txtCorrectIs">Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ</span>: <strong id="loseAnswer" style="color:#4ade80; font-size:8vh; display:block; margin-top:20px"></strong></div>
  </div>
</div>

<div id="celebration"><span id="celText">ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!</span></div>

<script>
// --- Data: Full 118 Elements ---
const elements = [
  {symbol:'H',name:'Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ†',en:'Hydrogen',val:['+1']},
  {symbol:'He',name:'Ø§Ù„Ù‡ÙŠÙ„ÙŠÙˆÙ…',en:'Helium',val:['0']},
  {symbol:'Li',name:'Ø§Ù„Ù„ÙŠØ«ÙŠÙˆÙ…',en:'Lithium',val:['+1']},
  {symbol:'Be',name:'Ø§Ù„Ø¨ÙŠØ±ÙŠÙ„ÙŠÙˆÙ…',en:'Beryllium',val:['+2']},
  {symbol:'B',name:'Ø§Ù„Ø¨ÙˆØ±ÙˆÙ†',en:'Boron',val:['+3']},
  {symbol:'C',name:'Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†',en:'Carbon',val:['+4','-4']},
  {symbol:'N',name:'Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†',en:'Nitrogen',val:['+5','-3']},
  {symbol:'O',name:'Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†',en:'Oxygen',val:['-2']},
  {symbol:'F',name:'Ø§Ù„ÙÙ„ÙˆØ±',en:'Fluorine',val:['-1']},
  {symbol:'Ne',name:'Ø§Ù„Ù†ÙŠÙˆÙ†',en:'Neon',val:['0']},
  {symbol:'Na',name:'Ø§Ù„ØµÙˆØ¯ÙŠÙˆÙ…',en:'Sodium',val:['+1']},
  {symbol:'Mg',name:'Ø§Ù„Ù…ØºÙ†ÙŠØ³ÙŠÙˆÙ…',en:'Magnesium',val:['+2']},
  {symbol:'Al',name:'Ø§Ù„Ø£Ù„Ù…Ù†ÙŠÙˆÙ…',en:'Aluminium',val:['+3']},
  {symbol:'Si',name:'Ø§Ù„Ø³ÙŠÙ„ÙŠÙƒÙˆÙ†',en:'Silicon',val:['+4','-4']},
  {symbol:'P',name:'Ø§Ù„ÙØ³ÙÙˆØ±',en:'Phosphorus',val:['+5','-3']},
  {symbol:'S',name:'Ø§Ù„ÙƒØ¨Ø±ÙŠØª',en:'Sulfur',val:['-2','+6']},
  {symbol:'Cl',name:'Ø§Ù„ÙƒÙ„ÙˆØ±',en:'Chlorine',val:['-1','+1','+5','+7']},
  {symbol:'Ar',name:'Ø§Ù„Ø£Ø±Ø¬ÙˆÙ†',en:'Argon',val:['0']},
  {symbol:'K',name:'Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…',en:'Potassium',val:['+1']},
  {symbol:'Ca',name:'Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ…',en:'Calcium',val:['+2']},
  {symbol:'Sc',name:'Ø§Ù„Ø³ÙƒØ§Ù†Ø¯ÙŠÙˆÙ…',en:'Scandium',val:['+3']},
  {symbol:'Ti',name:'Ø§Ù„ØªÙŠØªØ§Ù†ÙŠÙˆÙ…',en:'Titanium',val:['+4']},
  {symbol:'V',name:'Ø§Ù„ÙØ§Ù†Ø§Ø¯ÙŠÙˆÙ…',en:'Vanadium',val:['+5','+4']},
  {symbol:'Cr',name:'Ø§Ù„ÙƒØ±ÙˆÙ…',en:'Chromium',val:['+2','+3','+6']},
  {symbol:'Mn',name:'Ø§Ù„Ù…Ù†ØºÙ†ÙŠØ²',en:'Manganese',val:['+2','+4','+7']},
  {symbol:'Fe',name:'Ø§Ù„Ø­Ø¯ÙŠØ¯',en:'Iron',val:['+2','+3']},
  {symbol:'Co',name:'Ø§Ù„ÙƒÙˆØ¨Ø§Ù„Øª',en:'Cobalt',val:['+2','+3']},
  {symbol:'Ni',name:'Ø§Ù„Ù†ÙŠÙƒÙ„',en:'Nickel',val:['+2']},
  {symbol:'Cu',name:'Ø§Ù„Ù†Ø­Ø§Ø³',en:'Copper',val:['+1','+2']},
  {symbol:'Zn',name:'Ø§Ù„Ø²Ù†Ùƒ',en:'Zinc',val:['+2']},
  {symbol:'Ga',name:'Ø§Ù„ØºØ§Ù„ÙŠÙˆÙ…',en:'Gallium',val:['+3']},
  {symbol:'Ge',name:'Ø§Ù„Ø¬Ø±Ù…Ø§Ù†ÙŠÙˆÙ…',en:'Germanium',val:['+4']},
  {symbol:'As',name:'Ø§Ù„Ø²Ø±Ù†ÙŠØ®',en:'Arsenic',val:['+5','-3']},
  {symbol:'Se',name:'Ø§Ù„Ø³ÙŠÙ„ÙŠÙ†ÙŠÙˆÙ…',en:'Selenium',val:['-2','+4','+6']},
  {symbol:'Br',name:'Ø§Ù„Ø¨Ø±ÙˆÙ…',en:'Bromine',val:['-1']},
  {symbol:'Kr',name:'Ø§Ù„ÙƒØ±ÙŠØ¨ØªÙˆÙ†',en:'Krypton',val:['0']},
  {symbol:'Rb',name:'Ø§Ù„Ø±ÙˆØ¨ÙŠØ¯ÙŠÙˆÙ…',en:'Rubidium',val:['+1']},
  {symbol:'Sr',name:'Ø§Ù„Ø³ØªØ±ÙˆÙ†Ø´ÙŠÙˆÙ…',en:'Strontium',val:['+2']},
  {symbol:'Y',name:'Ø§Ù„Ø¥ØªØ±ÙŠÙˆÙ…',en:'Yttrium',val:['+3']},
  {symbol:'Zr',name:'Ø§Ù„Ø²Ø±ÙƒÙˆÙ†ÙŠÙˆÙ…',en:'Zirconium',val:['+4']},
  {symbol:'Nb',name:'Ø§Ù„Ù†ÙŠÙˆØ¨ÙŠÙˆÙ…',en:'Niobium',val:['+5']},
  {symbol:'Mo',name:'Ø§Ù„Ù…ÙˆÙ„ÙŠØ¨Ø¯ÙŠÙ†ÙˆÙ…',en:'Molybdenum',val:['+6']},
  {symbol:'Tc',name:'Ø§Ù„ØªÙƒÙ†ÙŠØ´ÙŠÙˆÙ…',en:'Technetium',val:['+7']},
  {symbol:'Ru',name:'Ø§Ù„Ø±ÙˆØ«ÙŠÙ†ÙŠÙˆÙ…',en:'Ruthenium',val:['+3','+4']},
  {symbol:'Rh',name:'Ø§Ù„Ø±ÙˆØ¯ÙŠÙˆÙ…',en:'Rhodium',val:['+3']},
  {symbol:'Pd',name:'Ø§Ù„Ø¨Ù„Ø§Ø¯ÙŠÙˆÙ…',en:'Palladium',val:['+2','+4']},
  {symbol:'Ag',name:'Ø§Ù„ÙØ¸Ø©',en:'Silver',val:['+1']},
  {symbol:'Cd',name:'Ø§Ù„ÙƒØ§Ø¯Ù…ÙŠÙˆÙ…',en:'Cadmium',val:['+2']},
  {symbol:'In',name:'Ø§Ù„Ø¥Ù†Ø¯ÙŠÙˆÙ…',en:'Indium',val:['+3']},
  {symbol:'Sn',name:'Ø§Ù„Ù‚ØµØ¯ÙŠØ±',en:'Tin',val:['+2','+4']},
  {symbol:'Sb',name:'Ø§Ù„Ø£Ù†ØªÙŠÙ…ÙˆÙ†',en:'Antimony',val:['+3','+5']},
  {symbol:'Te',name:'Ø§Ù„ØªÙŠÙ„ÙˆØ±ÙŠÙˆÙ…',en:'Tellurium',val:['-2','+4']},
  {symbol:'I',name:'Ø§Ù„ÙŠÙˆØ¯',en:'Iodine',val:['-1']},
  {symbol:'Xe',name:'Ø§Ù„Ø²ÙŠÙ†ÙˆÙ†',en:'Xenon',val:['0']},
  {symbol:'Cs',name:'Ø§Ù„Ø³ÙŠØ²ÙŠÙˆÙ…',en:'Cesium',val:['+1']},
  {symbol:'Ba',name:'Ø§Ù„Ø¨Ø§Ø±ÙŠÙˆÙ…',en:'Barium',val:['+2']},
  {symbol:'La',name:'Ø§Ù„Ù„Ø§Ù†Ø«Ø§Ù†ÙˆÙ…',en:'Lanthanum',val:['+3']},
  {symbol:'Ce',name:'Ø§Ù„Ø³ÙŠØ±ÙŠÙˆÙ…',en:'Cerium',val:['+3','+4']},
  {symbol:'Pr',name:'Ø¨Ø±Ø§Ø³ÙŠÙˆØ¯ÙŠÙ…ÙŠÙˆÙ…',en:'Praseodymium',val:['+3']},
  {symbol:'Nd',name:'Ù†ÙŠÙˆØ¯ÙŠÙ…ÙŠÙˆÙ…',en:'Neodymium',val:['+3']},
  {symbol:'Pm',name:'Ø¨Ø±ÙˆÙ…ÙŠØ«ÙŠÙˆÙ…',en:'Promethium',val:['+3']},
  {symbol:'Sm',name:'Ø³Ø§Ù…Ø§Ø±ÙŠÙˆÙ…',en:'Samarium',val:['+3']},
  {symbol:'Eu',name:'ÙŠÙˆØ±ÙˆØ¨ÙŠÙˆÙ…',en:'Europium',val:['+3','+2']},
  {symbol:'Gd',name:'ØºØ§Ø¯ÙˆÙ„ÙŠÙ†ÙŠÙˆÙ…',en:'Gadolinium',val:['+3']},
  {symbol:'Tb',name:'ØªÙŠØ±Ø¨ÙŠÙˆÙ…',en:'Terbium',val:['+3']},
  {symbol:'Dy',name:'Ø¯ÙŠØ³Ø¨Ø±ÙˆØ³ÙŠÙˆÙ…',en:'Dysprosium',val:['+3']},
  {symbol:'Ho',name:'Ù‡ÙˆÙ„Ù…ÙŠÙˆÙ…',en:'Holmium',val:['+3']},
  {symbol:'Er',name:'Ø¥Ø±Ø¨ÙŠÙˆÙ…',en:'Erbium',val:['+3']},
  {symbol:'Tm',name:'Ø«ÙˆÙ„ÙŠÙˆÙ…',en:'Thulium',val:['+3']},
  {symbol:'Yb',name:'Ø¥ÙŠØªØ±Ø¨ÙŠÙˆÙ…',en:'Ytterbium',val:['+3']},
  {symbol:'Lu',name:'Ù„ÙˆØªÙŠØ´ÙŠÙˆÙ…',en:'Lutetium',val:['+3']},
  {symbol:'Hf',name:'Ù‡Ø§ÙÙ†ÙŠÙˆÙ…',en:'Hafnium',val:['+4']},
  {symbol:'Ta',name:'ØªØ§Ù†ØªØ§Ù„ÙˆÙ…',en:'Tantalum',val:['+5']},
  {symbol:'W',name:'ØªÙ†Ø¬Ø³ØªÙ†',en:'Tungsten',val:['+6']},
  {symbol:'Re',name:'Ø±ÙŠÙ†ÙŠÙˆÙ…',en:'Rhenium',val:['+7']},
  {symbol:'Os',name:'Ø£ÙˆØ²Ù…ÙŠÙˆÙ…',en:'Osmium',val:['+4']},
  {symbol:'Ir',name:'Ø¥ÙŠØ±ÙŠØ¯ÙŠÙˆÙ…',en:'Iridium',val:['+4']},
  {symbol:'Pt',name:'Ø§Ù„Ø¨Ù„Ø§ØªÙŠÙ†',en:'Platinum',val:['+2','+4']},
  {symbol:'Au',name:'Ø§Ù„Ø°Ù‡Ø¨',en:'Gold',val:['+1','+3']},
  {symbol:'Hg',name:'Ø§Ù„Ø²Ø¦Ø¨Ù‚',en:'Mercury',val:['+1','+2']},
  {symbol:'Tl',name:'Ø§Ù„Ø«Ø§Ù„ÙŠÙˆÙ…',en:'Thallium',val:['+1','+3']},
  {symbol:'Pb',name:'Ø§Ù„Ø±ØµØ§Øµ',en:'Lead',val:['+2','+4']},
  {symbol:'Bi',name:'Ø§Ù„Ø¨Ø²Ù…ÙˆØª',en:'Bismuth',val:['+3']},
  {symbol:'Po',name:'Ø§Ù„Ø¨ÙˆÙ„ÙˆÙ†ÙŠÙˆÙ…',en:'Polonium',val:['+2','+4']},
  {symbol:'At',name:'Ø§Ù„Ø£Ø³ØªØ§ØªÙŠÙ†',en:'Astatine',val:['-1']},
  {symbol:'Rn',name:'Ø§Ù„Ø±Ø§Ø¯ÙˆÙ†',en:'Radon',val:['0']},
  {symbol:'Fr',name:'Ø§Ù„ÙØ±Ù†Ø³ÙŠÙˆÙ…',en:'Francium',val:['+1']},
  {symbol:'Ra',name:'Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆÙ…',en:'Radium',val:['+2']},
  {symbol:'Ac',name:'Ø§Ù„Ø£ÙƒØªÙŠÙ†ÙŠÙˆÙ…',en:'Actinium',val:['+3']},
  {symbol:'Th',name:'Ø§Ù„Ø«ÙˆØ±ÙŠÙˆÙ…',en:'Thorium',val:['+4']},
  {symbol:'Pa',name:'Ø§Ù„Ø¨Ø±ÙˆØªÙƒØªÙŠÙ†ÙŠÙˆÙ…',en:'Protactinium',val:['+5']},
  {symbol:'U',name:'Ø§Ù„ÙŠÙˆØ±Ø§Ù†ÙŠÙˆÙ…',en:'Uranium',val:['+6','+4']},
  {symbol:'Np',name:'Ø§Ù„Ù†Ø¨ØªÙˆÙ†ÙŠÙˆÙ…',en:'Neptunium',val:['+5']},
  {symbol:'Pu',name:'Ø§Ù„Ø¨Ù„ÙˆØªÙˆÙ†ÙŠÙˆÙ…',en:'Plutonium',val:['+4']},
  {symbol:'Am',name:'Ø§Ù„Ø£Ù…Ø±ÙŠØ³ÙŠÙˆÙ…',en:'Americium',val:['+3']},
  {symbol:'Cm',name:'Ø§Ù„ÙƒÙˆØ±ÙŠÙˆÙ…',en:'Curium',val:['+3']},
  {symbol:'Bk',name:'Ø§Ù„Ø¨Ø±ÙƒÙŠÙ„ÙŠÙˆÙ…',en:'Berkelium',val:['+3']},
  {symbol:'Cf',name:'Ø§Ù„ÙƒØ§Ù„ÙŠÙÙˆØ±Ù†ÙŠÙˆÙ…',en:'Californium',val:['+3']},
  {symbol:'Es',name:'Ø§Ù„Ø£ÙŠÙ†Ø´ØªØ§ÙŠÙ†ÙŠÙˆÙ…',en:'Einsteinium',val:['+3']},
  {symbol:'Fm',name:'Ø§Ù„ÙØ±Ù…ÙŠÙˆÙ…',en:'Fermium',val:['+3']},
  {symbol:'Md',name:'Ø§Ù„Ù…Ù†Ø¯Ù„ÙŠÙÙŠÙˆÙ…',en:'Mendelevium',val:['+3']},
  {symbol:'No',name:'Ø§Ù„Ù†ÙˆØ¨Ù„ÙŠÙˆÙ…',en:'Nobelium',val:['+2']},
  {symbol:'Lr',name:'Ø§Ù„ Ù„ÙˆØ±Ù†Ø³ÙŠÙˆÙ…',en:'Lawrencium',val:['+3']},
  {symbol:'Rf',name:'Ø§Ù„Ø±Ø°Ø±ÙÙˆØ±Ø¯ÙŠÙˆÙ…',en:'Rutherfordium',val:['+4']},
  {symbol:'Db',name:'Ø§Ù„Ø¯ÙˆØ¨Ù†ÙŠÙˆÙ…',en:'Dubnium',val:['+5']},
  {symbol:'Sg',name:'Ø§Ù„Ø³ÙŠ Ø¨ÙˆØ±Ø¬ÙŠÙˆÙ…',en:'Seaborgium',val:['+6']},
  {symbol:'Bh',name:'Ø§Ù„Ø¨ÙˆØ±ÙŠÙˆÙ…',en:'Bohrium',val:['+7']},
  {symbol:'Hs',name:'Ø§Ù„Ù‡Ø§Ø³ÙŠÙˆÙ…',en:'Hassium',val:['+8']},
  {symbol:'Mt',name:'Ø§Ù„Ù…Ø§ÙŠØªÙ†Ø±ÙŠÙˆÙ…',en:'Meitnerium',val:['+9']},
  {symbol:'Ds',name:'Ø§Ù„Ø¯Ø§Ø±Ù…Ø´ØªØ§ØªÙŠÙˆÙ…',en:'Darmstadtium',val:['+10']},
  {symbol:'Rg',name:'Ø§Ù„Ø±ÙˆÙ†ØªØ¬ÙŠÙ†ÙŠÙˆÙ…',en:'Roentgenium',val:['+11']},
  {symbol:'Cn',name:'Ø§Ù„ÙƒÙˆØ¨Ø±Ù†ÙŠØ³ÙŠÙˆÙ…',en:'Copernicium',val:['+12','+2']},
  {symbol:'Nh',name:'Ø§Ù„Ù†ÙŠÙ‡ÙˆÙ†ÙŠÙˆÙ…',en:'Nihonium',val:['+3']},
  {symbol:'Fl',name:'Ø§Ù„ÙÙ„ÙŠØ±ÙˆÙÙŠÙˆÙ…',en:'Flerovium',val:['+4','+2']},
  {symbol:'Mc',name:'Ø§Ù„Ù…ÙˆØ³ÙƒÙˆÙÙŠÙˆÙ…',en:'Moscovium',val:['+3','+1']},
  {symbol:'Lv',name:'Ø§Ù„Ù„ÙŠÙØ±Ù…ÙˆØ±ÙŠÙˆÙ…',en:'Livermorium',val:['+2']},
  {symbol:'Ts',name:'Ø§Ù„ØªÙŠÙ†ÙŠØ³ÙŠÙ†',en:'Tennessine',val:['-1']},
  {symbol:'Og',name:'Ø§Ù„Ø£ÙˆØºØ§Ù†ÙŠØ³ÙˆÙ†',en:'Oganesson',val:['0']}
];

// Easy Mode List
const easySymbols = ['H','Li','Be','Na','K','Rb','Cs','Mg','Ca','Sr','Ba','Cr','Mn','Fe','Co','Cu','Ag','Au','Zn','Hg','B','Al','C','Si','Sn','Pb','N','P','O','S','F','Cl','Br','I','He','Ne','Ar','Kr','Xe','Rn'];

// --- Translation Dictionary ---
const dictionary = {
  ar: {
    title: "âš›ï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ØªÙƒØ§ÙØ¤Ø§Øª",
    btnQuiz: "ğŸ§ª ØªØ­Ø¯ÙŠ Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ù†Ø§ØµØ±",
    btnVal: "âš–ï¸ ØªØ­Ø¯ÙŠ ØªÙƒØ§ÙØ¤Ø§Øª Ø§Ù„Ø¹Ù†Ø§ØµØ±",
    reset: "ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø­ÙØ¸",
    mode: "Ù†Ù‡Ø§Ø±/Ù„ÙŠÙ„",
    back: "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©",
    diff: "Ø§Ù„ØµØ¹ÙˆØ¨Ø©",
    time: "Ø§Ù„ÙˆÙ‚Øª",
    xp: "Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø©",
    rank: "Ø§Ù„Ø±ØªØ¨Ø©",
    easy: "Ø³Ù‡Ù„", hard: "ØµØ¹Ø¨",
    qHeader: "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØŸ",
    phSym: "Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§",
    check: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
    streak: "ğŸ”¥ ØªØªØ§Ø¨Ø¹",
    vHeader: "Ù…Ø§ Ù‡Ùˆ ØªÙƒØ§ÙØ¤ Ø§Ù„Ø¹Ù†ØµØ±ØŸ",
    vNote: "(Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¯ÙˆÙ† Ø¥Ø´Ø§Ø±Ø© ÙŠØ­Ø³Ø¨ Ù…ÙˆØ¬Ø¨)",
    wrong: "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!",
    correctIs: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ",
    cel: "ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø±ØªØ¨Ø©:"
  },
  en: {
    title: "âš›ï¸ Elements & Valencies",
    btnQuiz: "ğŸ§ª Symbol Challenge",
    btnVal: "âš–ï¸ Valency Challenge",
    reset: "ğŸ—‘ï¸ Reset Save",
    mode: "Day/Night",
    back: "Main Menu",
    diff: "Diff",
    time: "Time",
    xp: "XP",
    rank: "Rank",
    easy: "Easy", hard: "Hard",
    qHeader: "What is the Symbol?",
    phSym: "Type symbol here",
    check: "Submit Answer",
    streak: "ğŸ”¥ Streak",
    vHeader: "What is the Valency?",
    vNote: "(Note: No sign = Positive)",
    wrong: "Wrong Answer!",
    correctIs: "The correct answer is:",
    cel: "ğŸ‰ Congrats! New Rank:"
  }
};

const tiers=[
  {xp:0,name:'Ù…Ø¨ØªØ¯Ø¦ ÙƒÙŠÙ…ÙŠØ§Ø¡', en:'Novice Learner'},
  {xp:100,name:'Ø·Ø§Ù„Ø¨ Ù…Ø¬ØªÙ‡Ø¯', en:'Advanced Student'},
  {xp:300,name:'Ø®Ø¨ÙŠØ± Ø§Ù„Ù…Ø¹Ù…Ù„', en:'Lab Expert'},
  {xp:600,name:'Ù…Ø§ÙŠØ³ØªØ±Ùˆ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', en:'Chemistry Maestro'},
  {xp:1200,name:'Ø¹Ø§Ù„Ù… Ø°Ø±Ø©', en:'Atomic Scientist'},
  {xp:2500,name:'Ù…Ù†Ø¯Ù„ÙŠÙŠÙ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ', en:'Legendary Mendeleev'}
];

// --- Globals & DOM ---
let currentLang = 'ar';
const LS_KEY='chem_game_v8_final';
let activeTimer = null; 

const menu=document.getElementById('menu'), game=document.getElementById('game');
const menuQuiz=document.getElementById('menuQuiz'), menuVal=document.getElementById('menuVal');
const backMenu=document.getElementById('backMenu'), clearSaveBtn=document.getElementById('clearSave');
const toggleMode=document.getElementById('toggleMode'), langSelect=document.getElementById('langSelect');
const quizDiv=document.getElementById('quiz'), qName=document.getElementById('qName'), timerEl=document.getElementById('timer'), answerInput=document.getElementById('answer'), submitBtn=document.getElementById('submit'), streakEl=document.getElementById('streak'), xpEl=document.getElementById('xp'), rankEl=document.getElementById('rank'), timebar=document.getElementById('timebar');
const valDiv=document.getElementById('valency'), valPrompt=document.getElementById('valPrompt'), valTimerEl=document.getElementById('valTimer'), valAnswer=document.getElementById('valAnswer'), valSubmit=document.getElementById('valSubmit'), valStreakEl=document.getElementById('valStreak'), valTimebar=document.getElementById('valTimebar');
const loseScreen=document.getElementById('loseScreen'), loseAnswerEl=document.getElementById('loseAnswer');
const celebration=document.getElementById('celebration');

let xp=0, streak=0, current=null, quizList=[], quizIndex=0, valList=[], valIndex=0, timeLeft=0, currentMode=null;
const correctSound=new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
const wrongSound=new Audio('https://assets.mixkit.co/sfx/preview/mixkit-wrong-buzz-907.mp3');

// --- Helper Functions ---
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}
function clearAllTimers(){if(activeTimer){clearInterval(activeTimer); activeTimer=null;}}
function normalizeValInput(s){if(!s) return null;s=s.toString().trim().replace(/\s+/g,'');if(/^[+-]?\d+$/.test(s)){if(s==='0'||s==='+0'||s==='-0')return'0'; if(/^[+-]/.test(s))return (s[0]==='+')?('+'+parseInt(s,10)):'-'+Math.abs(parseInt(s,10)); return '+'+parseInt(s,10);} return null;}
function valAcceptedFor(elem,answerNormalized){if(!elem||!elem.val)return false; return elem.val.some(v=>{if(v==='0')return answerNormalized==='0'; return v===answerNormalized;});}

function calculateXP(){
  let base = 10;
  const timeSetting = parseInt(document.getElementById('timeLimit').value);
  const diffSetting = document.getElementById('difficulty').value;
  let multiplier = 1;
  if(timeSetting === 8) multiplier *= 1.5; 
  if(timeSetting === 20) multiplier *= 0.5; 
  if(diffSetting === 'hard') multiplier *= 1.5; 
  return Math.ceil(base * multiplier);
}

function showFloatingXP(amount, x, y){
  const el = document.createElement('div');
  el.className = 'xp-popup';
  el.textContent = `+${amount} XP`;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1000);
}

function getGameElements(){
  const diff = document.getElementById('difficulty').value;
  if(diff === 'easy'){
    return elements.filter(e => easySymbols.map(s=>s.toUpperCase()).includes(e.symbol.toUpperCase()));
  } else {
    return elements.slice();
  }
}

// --- Localization & Save ---
function applyLanguage(){
  const t = dictionary[currentLang];
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
  
  document.getElementById('titleText').textContent = t.title;
  menuQuiz.textContent = t.btnQuiz;
  menuVal.textContent = t.btnVal;
  clearSaveBtn.textContent = t.reset;
  document.getElementById('lblMode').textContent = t.mode;
  document.getElementById('txtBack').textContent = t.back;
  document.getElementById('lblDiff').textContent = t.diff;
  document.getElementById('lblTime').textContent = t.time;
  document.getElementById('lblXP').textContent = t.xp;
  document.getElementById('lblRank').textContent = t.rank;
  document.getElementById('optEasy').textContent = t.easy;
  document.getElementById('optHard').textContent = t.hard;
  document.getElementById('quizHeader').textContent = t.qHeader;
  answerInput.placeholder = t.phSym;
  document.getElementById('btnCheck1').textContent = t.check;
  document.getElementById('streakLbl1').textContent = t.streak;
  document.getElementById('quizTimerLbl').textContent = t.time;
  document.getElementById('valHeader').textContent = t.vHeader;
  document.getElementById('valNote').textContent = t.vNote;
  document.getElementById('btnCheck2').textContent = t.check;
  document.getElementById('streakLbl2').textContent = t.streak;
  document.getElementById('valTimerLbl').textContent = t.time;
  document.getElementById('txtWrong').textContent = t.wrong;
  document.getElementById('txtCorrectIs').textContent = t.correctIs;

  updateStats(false);
  if(current){
    if(currentMode==='quiz') qName.textContent = currentLang==='ar' ? current.name : current.en;
    if(currentMode==='valency') valPrompt.textContent = currentLang==='ar' ? current.name : current.en;
  }
}

function saveState(){
  const st={
    xp, streak, lang: currentLang,
    settings:{
      difficulty:document.getElementById('difficulty').value, 
      timeLimit:document.getElementById('timeLimit').value
    }
  }; 
  localStorage.setItem(LS_KEY,JSON.stringify(st));
}

function loadState(){
  try{
    const raw=localStorage.getItem(LS_KEY); 
    if(!raw) return; 
    const st=JSON.parse(raw); 
    xp=st.xp||0; 
    streak=st.streak||0; 
    if(st.lang) { currentLang = st.lang; langSelect.value = st.lang; }
    if(st.settings){
      document.getElementById('difficulty').value=st.settings.difficulty||'easy'; 
      document.getElementById('timeLimit').value=st.settings.timeLimit||'12';
    } 
    updateStats(false);
  }catch(e){console.warn('load failed',e);}
}

// --- Logic ---
function updateStats(checkCelebration=true){
  streakEl.textContent=streak;
  valStreakEl.textContent=streak;
  xpEl.textContent=xp;
  
  let oldRank = rankEl.textContent;
  let rObj = tiers[0];
  for(let i=tiers.length-1;i>=0;i--){if(xp>=tiers[i].xp){rObj=tiers[i]; break;}}
  
  const rankName = currentLang === 'ar' ? rObj.name : rObj.en;
  rankEl.textContent = rankName;

  if(checkCelebration && oldRank !== '...' && rankName !== oldRank){
    showCelebration(rankName);
  }
}

function showCelebration(rankName){
  clearAllTimers();
  const t = dictionary[currentLang];
  document.getElementById('celText').innerHTML = t.cel + "<br><strong style='font-size:7vh;display:block;margin-top:2vh'>" + rankName + "</strong>";
  celebration.classList.add('show');
  setTimeout(()=>{
    celebration.classList.remove('show'); 
    if(currentMode==='quiz') startQuizTimer();
    if(currentMode==='valency') startValTimer();
  },2500);
}

function showMenu(){
  clearAllTimers();
  menu.classList.remove('hidden'); 
  game.classList.add('hidden'); 
  hideAllModes(); 
  currentMode=null; 
  timerEl.textContent = '--';
  valTimerEl.textContent = '--';
}

function showGame(){
  menu.classList.add('hidden'); 
  game.classList.remove('hidden');
}

function hideAllModes(){
  quizDiv.classList.add('hidden'); 
  valDiv.classList.add('hidden');
}

function startQuiz(){
  clearAllTimers();
  quizList = getGameElements();
  shuffle(quizList); 
  quizIndex=0; 
  nextQuiz();
}

function nextQuiz(){
  clearAllTimers();
  if(quizIndex>=quizList.length){ quizList = getGameElements(); shuffle(quizList); quizIndex=0; }
  const el=quizList[quizIndex]; 
  current=el; 
  qName.textContent = currentLang==='ar' ? el.name : el.en;
  answerInput.value=''; 
  timeLeft=parseInt(document.getElementById('timeLimit').value); 
  timerEl.textContent=timeLeft; 
  timebar.style.width='100%'; 
  startQuizTimer();
  answerInput.focus();
}

function startQuizTimer(){
  clearAllTimers();
  activeTimer = setInterval(()=>{
    timeLeft--; 
    timerEl.textContent=timeLeft; 
    const totalTime = parseInt(document.getElementById('timeLimit').value);
    timebar.style.width=((timeLeft/totalTime)*100)+'%';
    if(timeLeft<=0){
      clearAllTimers(); 
      showLose(current.symbol);
    }
  },1000);
}

function submitQuizAnswer(){
  const ans=answerInput.value.trim(); 
  if(!ans) return; 
  const correct=ans.toUpperCase()===current.symbol.toUpperCase(); 
  if(correct){
    correctSound.play(); 
    streak++; 
    const pts = calculateXP();
    xp+=pts; 
    const rect = answerInput.getBoundingClientRect();
    showFloatingXP(pts, rect.left + rect.width/2, rect.top);
    quizIndex++; 
    updateStats(); 
    saveState(); 
    nextQuiz();
  } else {
    wrongSound.play(); 
    streak=0; 
    xp=Math.max(0,xp-5); 
    updateStats();
    showLose(current.symbol);
  } 
}

function startValency(){
  clearAllTimers();
  valList=getGameElements();
  shuffle(valList); 
  valIndex=0; 
  nextVal();
}

function nextVal(){
  clearAllTimers();
  if(valIndex>=valList.length){ valList=getGameElements(); shuffle(valList); valIndex=0; }
  const el=valList[valIndex]; 
  current=el; 
  valPrompt.textContent = currentLang==='ar' ? el.name : el.en;
  valAnswer.value=''; 
  timeLeft=parseInt(document.getElementById('timeLimit').value); 
  valTimerEl.textContent=timeLeft; 
  valTimebar.style.width='100%'; 
  startValTimer();
  valAnswer.focus();
}

function startValTimer(){
  clearAllTimers();
  activeTimer = setInterval(()=>{
    timeLeft--; 
    valTimerEl.textContent=timeLeft; 
    const totalTime = parseInt(document.getElementById('timeLimit').value);
    valTimebar.style.width=((timeLeft/totalTime)*100)+'%';
    if(timeLeft<=0){
      clearAllTimers(); 
      showLose(current.val.join(' / '));
    }
  },1000);
}

function submitValAnswer(){
  const ans=normalizeValInput(valAnswer.value); 
  if(ans && valAcceptedFor(current,ans)){
    correctSound.play(); 
    streak++; 
    const pts = calculateXP();
    xp+=pts; 
    const rect = valAnswer.getBoundingClientRect();
    showFloatingXP(pts, rect.left + rect.width/2, rect.top);
    valIndex++; 
    updateStats(); 
    saveState(); 
    nextVal();
  } else {
    wrongSound.play(); 
    streak=0; 
    xp=Math.max(0,xp-5); 
    updateStats();
    showLose(current.val.join(' / '));
  } 
}

function showLose(correctStr){
  clearAllTimers();
  loseAnswerEl.textContent=correctStr; 
  loseScreen.classList.add('show'); 
  setTimeout(()=>{
    loseScreen.classList.remove('show'); 
    if(currentMode==='quiz') { quizIndex++; nextQuiz(); }
    else if(currentMode==='valency') { valIndex++; nextVal(); }
  },2500);
}

// Events
menuQuiz.onclick=()=>{
  clearAllTimers();
  showGame(); 
  hideAllModes(); 
  quizDiv.classList.remove('hidden'); 
  currentMode='quiz'; 
  startQuiz();
};
menuVal.onclick=()=>{
  clearAllTimers();
  showGame(); 
  hideAllModes(); 
  valDiv.classList.remove('hidden'); 
  currentMode='valency'; 
  startValency();
};
backMenu.onclick=()=>{
  clearAllTimers();
  showMenu();
};
clearSaveBtn.onclick=()=>{localStorage.removeItem(LS_KEY); location.reload();}
toggleMode.onchange=()=>{document.body.classList.toggle('light',toggleMode.checked);}
langSelect.onchange=()=>{
  currentLang = langSelect.value;
  applyLanguage();
  saveState();
};
submitBtn.onclick=submitQuizAnswer; 
answerInput.addEventListener('keydown',e=>{if(e.key==='Enter') submitQuizAnswer();});
valSubmit.onclick=submitValAnswer; 
valAnswer.addEventListener('keydown',e=>{if(e.key==='Enter') submitValAnswer();});

loadState();
applyLanguage();
showMenu();
</script>
</body>
</html>
